<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="MLflow is a very nice tool to handle our MLOps needs. It covers several important features for doing MLOps, namely tracking server, model registry, and source code packaging. Here we are going to focu">
<meta property="og:type" content="article">
<meta property="og:title" content="MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component">
<meta property="og:url" content="https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/">
<meta property="og:site_name" content="Izzuddin Ahsanujunda Blog">
<meta property="og:description" content="MLflow is a very nice tool to handle our MLOps needs. It covers several important features for doing MLOps, namely tracking server, model registry, and source code packaging. Here we are going to focu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=15HAAfWRx1NUl1sLCU-tiJzP0e2OR-s-p">
<meta property="article:published_time" content="2021-08-02T14:49:38.000Z">
<meta property="article:modified_time" content="2022-08-06T08:46:20.858Z">
<meta property="article:author" content="Izzuddin Ahsanujunda">
<meta property="article:tag" content="data science, data analysis, machine learning, software development, data engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/20210517/Intuition-to-Recommender-System-for-Implicit-Feedback-Dataset/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&text=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&is_video=false&description=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component&body=Check out this article: https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&name=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component&description=&lt;p&gt;MLflow is a very nice tool to handle our MLOps needs. It covers several important features for doing MLOps, namely tracking server, model registry, and source code packaging. Here we are going to focus on &lt;a href=&#34;https://mlflow.org/docs/latest/projects.html&#34;&gt;MLFlow Projects&lt;/a&gt;, the source code packaging feature that can help us develop a reproducible machine learning pipeline.&lt;/p&gt;
&lt;p&gt;MLFlow projects enable us to run source codes in a consistent way by encapsulating the runtime environment together with the source code, so that we can develop our source code on OSX, and have it run on linux with the same reproducible result, if we so need.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&t=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Initial-setup"><span class="toc-number">1.</span> <span class="toc-text">Initial setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-main-entry-point"><span class="toc-number">2.</span> <span class="toc-text">Develop main entry point</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-get-data-step"><span class="toc-number">3.</span> <span class="toc-text">Develop get_data step</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-run"><span class="toc-number">4.</span> <span class="toc-text">Test run</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Izzuddin Ahsanujunda</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-08-02T14:49:38.000Z" itemprop="datePublished">2021-08-02</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>MLflow is a very nice tool to handle our MLOps needs. It covers several important features for doing MLOps, namely tracking server, model registry, and source code packaging. Here we are going to focus on <a target="_blank" rel="noopener" href="https://mlflow.org/docs/latest/projects.html">MLFlow Projects</a>, the source code packaging feature that can help us develop a reproducible machine learning pipeline.</p>
<p>MLFlow projects enable us to run source codes in a consistent way by encapsulating the runtime environment together with the source code, so that we can develop our source code on OSX, and have it run on linux with the same reproducible result, if we so need.</p>
<span id="more"></span>
<p>Let’s imagine we build a machine learning training pipeline with the following function sequence.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r" alt="image"></p>
<p>Leveraging the mlflow project will enable us to develop and run each component as a separate module. When we need to pass output of one component as an input of the succeeding component, we can do this as an argument.</p>
<p>I say, it’s enough talking and let’s start making!</p>
<h2 id="Initial-setup"><a href="#Initial-setup" class="headerlink" title="Initial setup"></a>Initial setup</h2><p>To start building a pipeline using the mlflow project, we need to install the <code>mlflow</code> library. This can easily be done using <code>pip install mlflow</code>. This will be useful to test run our pipeline code later. For the sake of clarity, I will build a model to predict AirBnB rental prices in NYC.</p>
<p>Let’s start by making a new directory, and change into it.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir nyc_airbnb_pipeline</span><br><span class="line">cd nyc_airbnb_pipeline</span><br></pre></td></tr></table></figure>
<p>To start building with the mlflow project, we need to create several mandatory files.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch conda.yml MLproject config.yaml</span><br></pre></td></tr></table></figure>
<p>The <code>MLproject</code> file dictates how mlflow should run our source code. While <code>conda.yml</code> will be used to define our python environment to run the code.</p>
<p>For our needs, let’s fill the <code>MLproject</code> file with the following configuration.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./MLProject</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nyc_airbnb</span></span><br><span class="line"><span class="attr">conda_env:</span> <span class="string">conda.yml</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">entry_points:</span></span><br><span class="line"> <span class="attr">main:</span></span><br><span class="line">   <span class="attr">parameters:</span></span><br><span class="line">     <span class="attr">steps:</span></span><br><span class="line">       <span class="attr">description:</span> <span class="string">Comma-separated</span> <span class="string">list</span> <span class="string">of</span> <span class="string">steps</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">(useful</span> <span class="string">for</span> <span class="string">debugging)</span></span><br><span class="line">       <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">       <span class="attr">default:</span> <span class="string">all</span></span><br><span class="line">     <span class="attr">hydra_options:</span></span><br><span class="line">       <span class="attr">description:</span> <span class="string">Other</span> <span class="string">configuration</span> <span class="string">parameters</span> <span class="string">to</span> <span class="string">override</span></span><br><span class="line">       <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">       <span class="attr">default:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   <span class="attr">command:</span> <span class="string">&quot;python main.py main.steps=\\&#x27;&#123;steps&#125;\\&#x27; $(echo &#123;hydra_options&#125;)&quot;</span></span><br></pre></td></tr></table></figure>
<p>Let’s go through this.</p>
<p>We first define the name of the environment we are running our source code in, called <code>nyc_airbnb</code>. Then we specify the file that contains how to create this environment in the <code>conda_env</code> part, with python it is common to use conda environment, therefore we provide our <code>conda.yml</code> into this. This file is currently empty but we will put something later.</p>
<p>After that we specify entry points. Mlflow asks that every <code>MLproject</code> should contain a <code>main</code> entry point. When we run our code with mlflow, it will start by triggering the <code>main.py</code>.</p>
<p>Now, let’s write into <code>conda.yml</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./conda.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nyc_airbnb</span></span><br><span class="line"><span class="attr">channels:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">conda-forge</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">defaults</span></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">python=3.8.12</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">autopep8=1.5.7</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">click=8.0.3</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">oss2=2.15.0</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">numpy=1.21.2</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">pandas=1.3.3</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">coverage=6.0</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">python-dotenv=0.19.0</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">hydra-core=1.0.6</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">pip=21.2.4</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">python-decouple</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">pyarrow=6.0.1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">scikit-learn=0.24.1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">scipy=1.7.3</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">tqdm=4.62.3</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">imbalanced-learn=0.8.1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">wandb=0.12.1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">pytorch=1.10.0</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">mlflow=1.20.2</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">pip:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">fsspec==2021.11.0</span></span><br></pre></td></tr></table></figure>
<p>Mlflow will create this python virtual environment before it starts to run our source code, it will only create a new environment once to speed-up subsequent processes. An exception is when we modify the dependecy verison or add a new dependency, mlflow will create a new environment so that the source code starts fresh.</p>
<p>For local development purposes, we should also create this virtual enviroment in our machine.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda env create -f conda.yml</span><br><span class="line">conda activate nyc_airbnb</span><br></pre></td></tr></table></figure>
<h2 id="Develop-main-entry-point"><a href="#Develop-main-entry-point" class="headerlink" title="Develop main entry point"></a>Develop main entry point</h2><p>Now we can start to create our main entry point by making the directories.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch main.py</span><br></pre></td></tr></table></figure>
<p>Let’s open the <code>main.py</code> file, and write code in it.</p>
<blockquote>
<p>.&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">import</span> hydra</span><br><span class="line"><span class="keyword">from</span> omegaconf <span class="keyword">import</span> DictConfig</span><br><span class="line"></span><br><span class="line">_steps = [</span><br><span class="line">    <span class="string">&quot;download&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This automatically reads in the configuration</span></span><br><span class="line"><span class="meta">@hydra.main(<span class="params">config_name=<span class="string">&#x27;config&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go</span>(<span class="params">config: DictConfig</span>):</span><br><span class="line">    <span class="comment"># Setup the wandb experiment. All runs will be grouped under this name</span></span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;project_name&quot;</span>]</span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_RUN_GROUP&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;experiment_name&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Steps to execute</span></span><br><span class="line">    steps_par = config[<span class="string">&#x27;main&#x27;</span>][<span class="string">&#x27;steps&#x27;</span>]</span><br><span class="line">    active_steps = steps_par.split(<span class="string">&quot;,&quot;</span>) <span class="keyword">if</span> steps_par != <span class="string">&quot;all&quot;</span> <span class="keyword">else</span> _steps</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Move to a temporary directory</span></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;download&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            <span class="comment"># Download file and load in W&amp;B</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    go()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>There is a lot to digest here so please bear with me.</p>
<p>We start by declaring our execution step as a list <code>_steps</code>. We start with only <code>download</code> in there, but we are going to grow it as we progress.</p>
<p>After that, we create a wrapper function called <code>go()</code> where we are going to put the execution logic. We use <code>hydra</code> to handle our configuration. All of our config will be declared inside a separate <code>config.yaml</code> file. Hydra needs to be tied-in to <code>go()</code> function as a decorator.</p>
<p>We start the function by setting up the environment variable, we read in the config from hydra and put it into the system’s env variable.</p>
<p>After that we prepare <code>active_steps</code> - actual steps to execute. currently we only have one step so this part doesn’t do much, but once we have multiple steps, it will allow us to override execution of <code>_steps</code> by running this form CLI</p>
<p><code>mlflow run . -P steps=train</code></p>
<p>if we run without <code>steps</code> argument like this <code>mlflow run .</code>, the list we have in <code>_steps</code> will be used instead.</p>
<p>Next part is where we put the skeleton that is going to tell mlflow what to run if <code>download</code> is in the steps that we should run.</p>
<h2 id="Develop-get-data-step"><a href="#Develop-get-data-step" class="headerlink" title="Develop get_data step"></a>Develop get_data step</h2><p>We need a way to digest the data from a source system into our training pipeline. Source systems can be a data warehouse, a flat file on a shared file system, or by scrapping a web page. Once we obtain this data, we want to log this data so that we can later revisit which data results in which model. For our case, the data is obtained from Alibaba Cloud OSS. If you are familiar with AWS S3, OSS is what S3 in alibaba cloud platform is called.</p>
<p>To start, let’s create the file to hold our download logic.</p>
<p><code>touch nyc_airbnb/get_data.py</code></p>
<p>Open this file and let’s put in our logic there.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;get_data.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> oss2</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"> </span><br><span class="line">sys.path.append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> nyc_airbnb.utils.base_runner <span class="keyword">import</span> BaseRunner</span><br><span class="line"> </span><br><span class="line">logging.basicConfig(</span><br><span class="line">   level=logging.INFO,</span><br><span class="line">   <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.info(sys.path)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GetOSSDataRunner</span>(<span class="title class_ inherited__">BaseRunner</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                wandb_run,</span></span><br><span class="line"><span class="params">                artifact_name,</span></span><br><span class="line"><span class="params">                artifact_type,</span></span><br><span class="line"><span class="params">                artifact_description</span>):</span><br><span class="line">       <span class="built_in">super</span>().__init__(wandb_run)</span><br><span class="line">       self.artifact_name = artifact_name</span><br><span class="line">       self.artifact_type = artifact_type</span><br><span class="line">       self.artifact_description = artifact_description</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">get_oss_data</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                    bucket,</span></span><br><span class="line"><span class="params">                    object_path,</span></span><br><span class="line"><span class="params">                    local_directory</span>):</span><br><span class="line">       self.wandb_run.config.update(&#123;</span><br><span class="line">           <span class="string">&#x27;bucket&#x27;</span>: bucket,</span><br><span class="line">           <span class="string">&#x27;object-path&#x27;</span>: object_path</span><br><span class="line">       &#125;)</span><br><span class="line"> </span><br><span class="line">       <span class="comment"># Setup OSS Connection</span></span><br><span class="line">       logger.info(<span class="string">&quot;Connecting to Aliyun&quot;</span>)</span><br><span class="line">       auth = oss2.Auth(</span><br><span class="line">           os.environ[<span class="string">&#x27;OSS_ACCESS_KEY_ID&#x27;</span>],</span><br><span class="line">           os.environ[<span class="string">&#x27;OSS_ACCESS_KEY_SECRET&#x27;</span>]</span><br><span class="line">       )</span><br><span class="line">       bucket = oss2.Bucket(</span><br><span class="line">           auth,</span><br><span class="line">           <span class="string">&#x27;https://oss-ap-southeast-5.aliyuncs.com&#x27;</span>,</span><br><span class="line">           bucket</span><br><span class="line">       )</span><br><span class="line"> </span><br><span class="line">       object_list = []</span><br><span class="line">       <span class="keyword">for</span> obj <span class="keyword">in</span> oss2.ObjectIteratorV2(bucket, prefix=object_path):</span><br><span class="line">           object_list.append(obj.key)</span><br><span class="line"> </span><br><span class="line">       <span class="comment"># Check exported file in OSS</span></span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           <span class="keyword">assert</span> <span class="built_in">len</span>(object_list) &lt;= <span class="number">2</span></span><br><span class="line">       <span class="keyword">except</span> AssertionError <span class="keyword">as</span> err:</span><br><span class="line">           logger.error(<span class="string">&#x27;Expect OSS path to contain only 1 file&#x27;</span>)</span><br><span class="line">           <span class="keyword">raise</span> err</span><br><span class="line"> </span><br><span class="line">       object_key = object_list[-<span class="number">1</span>]</span><br><span class="line"> </span><br><span class="line">       logger.info(<span class="string">&quot;Downloading object from OSS&quot;</span>)</span><br><span class="line">       temp_filename = os.path.join(local_directory, <span class="string">&#x27;csv_file.csv&#x27;</span>)</span><br><span class="line">       bucket.get_object_to_file(object_key, temp_filename)</span><br><span class="line"> </span><br><span class="line">       df = pd.read_csv(temp_filename)</span><br><span class="line"> </span><br><span class="line">       parquet_filename = <span class="built_in">str</span>(<span class="string">f&#x27;<span class="subst">&#123;local_directory&#125;</span>/<span class="subst">&#123;self.artifact_name&#125;</span>&#x27;</span>)</span><br><span class="line">       logger.info(<span class="string">&quot;Exporting pandas dataframe to %s&quot;</span> % parquet_filename)</span><br><span class="line">       df.to_parquet(</span><br><span class="line">           parquet_filename,</span><br><span class="line">           index=<span class="literal">False</span>,</span><br><span class="line">           engine=<span class="string">&#x27;pyarrow&#x27;</span>,</span><br><span class="line">           compression=<span class="string">&#x27;gzip&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">       <span class="keyword">return</span> parquet_filename</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   <span class="comment"># process arguments</span></span><br><span class="line">   parser = argparse.ArgumentParser(description=<span class="string">&quot;Download URL to a local destination&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;bucket&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Name of the sample to download&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;object_path&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Name of the sample to download&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;artifact_name&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Name for the output artifact&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;artifact_type&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Output artifact type.&quot;</span>)</span><br><span class="line">   parser.add_argument(</span><br><span class="line">       <span class="string">&quot;artifact_description&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;A brief description of this artifact&quot;</span></span><br><span class="line">   )</span><br><span class="line">   args = parser.parse_args()</span><br><span class="line"> </span><br><span class="line">   <span class="comment"># apply arguments to run</span></span><br><span class="line">   runner = GetOSSDataRunner(</span><br><span class="line">       wandb.init(job_type=<span class="string">&quot;download_file&quot;</span>),</span><br><span class="line">       args.artifact_name,</span><br><span class="line">       args.artifact_type,</span><br><span class="line">       args.artifact_description</span><br><span class="line">   )</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> temp_dir:</span><br><span class="line">       LOCAL_FILE = runner.get_oss_data(args.bucket, args.object_path, temp_dir)</span><br><span class="line">       _ = runner.log_artifact(</span><br><span class="line">           args.artifact_name,</span><br><span class="line">           args.artifact_type,</span><br><span class="line">           args.artifact_description,</span><br><span class="line">           LOCAL_FILE</span><br><span class="line">       )</span><br><span class="line"> </span><br><span class="line">   sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>This looks intimidating but actually simple, we just download our data from a specific OSS bucket with a specific path. We expect that the path should contain only 1 file, and we get that file. To ease our successsive steps, we log this file in <code>parquet</code> format, <code>parquet</code> is columnar file format that is really optimised to store data for analytics purposes.</p>
<p>To access OSS, we need to use an access key and a secret. To securely use this in a development environment, we can put this info inside the <code>.env</code> file. Create the file in our root directory, and put our alibaba cloud access key and secret there.</p>
<blockquote>
<p>.&#x2F;.env</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OSS_ACCESS_KEY_ID=s3cr3t                       </span><br><span class="line">OSS_ACCESS_KEY_SECRET=s3cr3t           </span><br></pre></td></tr></table></figure>
</blockquote>
<p>We also need to put this parquet file somewhere, we can put this in the machine’s local file system. However we might encounter problems when we are working with huge data volumes, therefore we are going to make use of weight’s and biases (wandb for simplicity). Wandb has many uses, but here we only utilise the artifact store function. Don’t forget to get our wandb access key from <code>https://wandb.ai/authorize</code> and put the value from there into the <code>.env</code> file as well.</p>
<blockquote>
<p>.&#x2F;.env</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OSS_ACCESS_KEY_ID=s3cr3t                       </span><br><span class="line">OSS_ACCESS_KEY_SECRET=s3cr3t           </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WANDB_API_KEY=s3cr3t</span><br></pre></td></tr></table></figure>
</blockquote>
<p>All of our component steps will interact with wandb, so we need to build this as a shared utility. Create a new file to hold this shared utility.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir nyc_airbnb/utils</span><br><span class="line">touch nyc_airbnb/utils/base_runner.py</span><br></pre></td></tr></table></figure>

<p>Open this new file and copy paste the following code.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;utils&#x2F;base_runner.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseRunner</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, wandb_run</span>):</span><br><span class="line">        self.wandb_run = wandb_run</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_artifact</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                     artifact_name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     artifact_type: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     artifact_description: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     filename: <span class="built_in">str</span></span>) -&gt; wandb.Artifact:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Log the provided local filename as an artifact in W&amp;B, and add the artifact path</span></span><br><span class="line"><span class="string">        to the MLFlow run so it can be retrieved by subsequent steps in a pipeline</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            artifact_name: name for the artifact</span></span><br><span class="line"><span class="string">            artifact_type:</span></span><br><span class="line"><span class="string">                type for the artifact (just a string like &quot;raw_data&quot;, &quot;clean_data&quot; and so on)</span></span><br><span class="line"><span class="string">            artifact_description: a brief description of the artifact</span></span><br><span class="line"><span class="string">            filename: local filename for the artifact</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Wandb artifact object</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Log to W&amp;B</span></span><br><span class="line">        artifact = wandb.Artifact(</span><br><span class="line">            artifact_name,</span><br><span class="line">            <span class="built_in">type</span>=artifact_type,</span><br><span class="line">            description=artifact_description,</span><br><span class="line">        )</span><br><span class="line">        artifact.add_file(filename)</span><br><span class="line">        self.wandb_run.log_artifact(artifact)</span><br><span class="line">        logger.info(<span class="string">f&quot;Uploading <span class="subst">&#123;artifact_name&#125;</span> to Weights &amp; Biases&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We need to call .wait() method to ensure that artifact transport has completed</span></span><br><span class="line">        <span class="comment"># before we exit this method execution</span></span><br><span class="line">        <span class="keyword">if</span> wandb.run.mode == <span class="string">&#x27;online&#x27;</span>:</span><br><span class="line">            artifact.wait()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> artifact</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_model</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                  artifact_name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                  artifact_type: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                  artifact_description: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                  model_dir: <span class="built_in">str</span></span>) -&gt; wandb.Artifact:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Log the provided local filename as an artifact in W&amp;B, and add the artifact path</span></span><br><span class="line"><span class="string">        to the MLFlow run so it can be retrieved by subsequent steps in a pipeline</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            artifact_name: name for the artifact</span></span><br><span class="line"><span class="string">            artifact_type:</span></span><br><span class="line"><span class="string">                type for the artifact (just a string like &quot;raw_data&quot;, &quot;clean_data&quot; and so on)</span></span><br><span class="line"><span class="string">            artifact_description: a brief description of the artifact</span></span><br><span class="line"><span class="string">            model_dir: local path for the model directory</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Wandb artifact object</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Log to W&amp;B</span></span><br><span class="line">        artifact = wandb.Artifact(</span><br><span class="line">            artifact_name,</span><br><span class="line">            <span class="built_in">type</span>=artifact_type,</span><br><span class="line">            description=artifact_description,</span><br><span class="line">        )</span><br><span class="line">        artifact.add_dir(model_dir)</span><br><span class="line">        self.wandb_run.log_artifact(artifact)</span><br><span class="line">        <span class="comment"># We need to call .wait() method to ensure that artifact transport has completed</span></span><br><span class="line">        <span class="comment"># before we exit this method execution</span></span><br><span class="line">        <span class="keyword">if</span> wandb.run.mode == <span class="string">&#x27;online&#x27;</span>:</span><br><span class="line">            artifact.wait()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> artifact</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_dataset_artifact</span>(<span class="params">self, artifact_name</span>) -&gt; pd.DataFrame:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve wandb artifact as pandas DataFrame, artifact_name should exist in</span></span><br><span class="line"><span class="string">        the context of current run. This function will only retrieve dataset artifact,</span></span><br><span class="line"><span class="string">        not model or any other artifact type.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            artifact_name: name for the artifact</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            DataFrame representation of the artifact</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        artifact_local_path = self.wandb_run.use_artifact(artifact_name).file()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = pd.read_parquet(artifact_local_path)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> err:</span><br><span class="line">            logger.error(<span class="string">f&quot;<span class="subst">&#123;artifact_name&#125;</span> is not found&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> err</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Now we are ready to set this up into our main entry point. Let’s open the <code>MLproject</code> file and put a new entry point. Below snippet separates the part that is new additon.</p>
<blockquote>
<p>.&#x2F;MLproject</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">nyc_airbnb</span></span><br><span class="line"><span class="attr">conda_env:</span> <span class="string">conda.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">entry_points:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Comma-separated</span> <span class="string">list</span> <span class="string">of</span> <span class="string">steps</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">(useful</span> <span class="string">for</span> <span class="string">debugging)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">hydra_options:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Other</span> <span class="string">configuration</span> <span class="string">parameters</span> <span class="string">to</span> <span class="string">override</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python main.py main.steps=\\&#x27;&#123;steps&#125;\\&#x27; $(echo &#123;hydra_options&#125;)&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">get_data:</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">bucket:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">bucket</span> <span class="string">where</span> <span class="string">data</span> <span class="string">is</span> <span class="string">stored</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">object_path:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">object</span> <span class="string">of</span> <span class="string">dataset</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">artifact_name:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Name</span> <span class="string">for</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">artifact_type:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Type</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact.</span> <span class="string">This</span> <span class="string">will</span> <span class="string">be</span> <span class="string">used</span> <span class="string">to</span> <span class="string">categorize</span> <span class="string">the</span> <span class="string">artifact</span> <span class="string">in</span> <span class="string">the</span> <span class="string">W&amp;B</span> <span class="string">interface</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">artifact_description:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">A</span> <span class="string">brief</span> <span class="string">description</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/get_data.py</span></span><br><span class="line"><span class="string">      &#123;bucket&#125;</span></span><br><span class="line"><span class="string">      &#123;object_path&#125;</span></span><br><span class="line"><span class="string">      &#123;artifact_name&#125;</span></span><br><span class="line"><span class="string">      &#123;artifact_type&#125;</span></span><br><span class="line"><span class="string">      &#123;artifact_description&#125;&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>Now open <code>main.py</code> and let’s call our new entry point from the main entry point.</p>
<blockquote>
<p>.&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> hydra</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> omegaconf <span class="keyword">import</span> DictConfig</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"> </span><br><span class="line">load_dotenv()</span><br><span class="line"> </span><br><span class="line">logging.basicConfig(</span><br><span class="line">   level=logging.INFO,</span><br><span class="line">   <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">_steps = [</span><br><span class="line">   <span class="string">&quot;download&quot;</span></span><br><span class="line">]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@hydra.main(<span class="params">config_name=<span class="string">&#x27;config&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go</span>(<span class="params">config: DictConfig</span>):</span><br><span class="line">   <span class="comment"># Env preparation</span></span><br><span class="line">   os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;project_name&quot;</span>]</span><br><span class="line">   os.environ[<span class="string">&quot;WANDB_RUN_GROUP&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;experiment_name&quot;</span>]</span><br><span class="line"> </span><br><span class="line">   <span class="comment"># Steps to execute</span></span><br><span class="line">   steps_par = config[<span class="string">&#x27;main&#x27;</span>][<span class="string">&#x27;steps&#x27;</span>]</span><br><span class="line">   active_steps = steps_par.split(<span class="string">&quot;,&quot;</span>) <span class="keyword">if</span> steps_par != <span class="string">&quot;all&quot;</span> <span class="keyword">else</span> _steps</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line"> </span><br><span class="line">       <span class="keyword">if</span> <span class="string">&quot;download&quot;</span> <span class="keyword">in</span> active_steps:</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">           _ = mlflow.run(</span><br><span class="line">               hydra.utils.get_original_cwd(),</span><br><span class="line">               <span class="string">&quot;get_data&quot;</span>,</span><br><span class="line">               parameters=&#123;</span><br><span class="line">                   <span class="string">&quot;bucket&quot;</span>: config[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;bucket&quot;</span>],</span><br><span class="line">                   <span class="string">&quot;object_path&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;artifact_name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;artifact_type&quot;</span>: <span class="string">&quot;raw_data&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;artifact_description&quot;</span>: <span class="string">&quot;Raw dataset from data store&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           )</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   go()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>We call <code>mlflow.run()</code> if <code>download</code> is called. We pass all arguments needed by <code>get_data</code> as parameters of <code>mlflow.run()</code>. These arguments are retrieved from <code>config.yaml</code> that is currently empty, so our next step is to make this config file.</p>
<blockquote>
<p>.&#x2F;config.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main:</span><br><span class="line">  project_name: &quot;housing_price&quot;</span><br><span class="line">  experiment_name: &quot;torch_lasso_model&quot;</span><br><span class="line">  steps: all</span><br><span class="line">data:</span><br><span class="line">  bucket: &quot;dana-mle&quot;</span><br><span class="line">  object: &quot;dataset/full_data/&quot;</span><br><span class="line">  raw_data: &quot;raw_training_data.parquet&quot;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>The Hydra library will read this configuration, parse it as python Dict, and we consume this Dict within our <code>go()</code> function.</p>
<h2 id="Test-run"><a href="#Test-run" class="headerlink" title="Test run"></a>Test run</h2><p>Now we have implemented the skeleton with a single component to download our data. To test run it, simply execute this CLI command.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlflow run .</span><br></pre></td></tr></table></figure>
<p>mlflow will create a new virtual environment, and run the first step <code>download</code> to get our data based on the <code>config.yaml</code> file. We can see the retrieved data by logging in to the wandb.ai dashboard and open artifact.</p>
<p><img src="https://drive.google.com/uc?export=view&id=15HAAfWRx1NUl1sLCU-tiJzP0e2OR-s-p" alt="wandb.ai artifact"></p>
<p>We can see that our dataset has now been logged in wandb and can be used for subsequent steps.</p>
<p>The state of our source code can also be checked from <a target="_blank" rel="noopener" href="https://github.com/iahsanujunda/nyc_airbnb_pipeline">this github repository</a> on branch named <code>part-1</code>.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Initial-setup"><span class="toc-number">1.</span> <span class="toc-text">Initial setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-main-entry-point"><span class="toc-number">2.</span> <span class="toc-text">Develop main entry point</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-get-data-step"><span class="toc-number">3.</span> <span class="toc-text">Develop get_data step</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-run"><span class="toc-number">4.</span> <span class="toc-text">Test run</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&text=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&is_video=false&description=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component&body=Check out this article: https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&title=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&name=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component&description=&lt;p&gt;MLflow is a very nice tool to handle our MLOps needs. It covers several important features for doing MLOps, namely tracking server, model registry, and source code packaging. Here we are going to focus on &lt;a href=&#34;https://mlflow.org/docs/latest/projects.html&#34;&gt;MLFlow Projects&lt;/a&gt;, the source code packaging feature that can help us develop a reproducible machine learning pipeline.&lt;/p&gt;
&lt;p&gt;MLFlow projects enable us to run source codes in a consistent way by encapsulating the runtime environment together with the source code, so that we can develop our source code on OSX, and have it run on linux with the same reproducible result, if we so need.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/&t=MLOps Part 1 - Intro to MLflow Project and Setting-up Our First Component"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2022
    Izzuddin Ahsanujunda
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
