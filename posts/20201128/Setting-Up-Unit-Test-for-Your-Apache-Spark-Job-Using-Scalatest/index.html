<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="By nature, machine learning models that run on production need to deal with… well… data, presumably lots of them. There will be times that among many data that our model need to deal with, there will">
<meta property="og:type" content="article">
<meta property="og:title" content="Setting Up Unit Test for Your Apache Spark Job Using Scalatest">
<meta property="og:url" content="https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/">
<meta property="og:site_name" content="Izzuddin Ahsanujunda Blog">
<meta property="og:description" content="By nature, machine learning models that run on production need to deal with… well… data, presumably lots of them. There will be times that among many data that our model need to deal with, there will">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-11-28T01:15:10.000Z">
<meta property="article:modified_time" content="2022-08-09T02:14:53.893Z">
<meta property="article:author" content="Izzuddin Ahsanujunda">
<meta property="article:tag" content="data science, data analysis, machine learning, software development, data engineering">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Setting Up Unit Test for Your Apache Spark Job Using Scalatest</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/About-Me/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/20210517/Intuition-to-Recommender-System-for-Implicit-Feedback-Dataset/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/20200607/Collecting-and-Managing-your-Data/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&text=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&is_video=false&description=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Setting Up Unit Test for Your Apache Spark Job Using Scalatest&body=Check out this article: https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&name=Setting Up Unit Test for Your Apache Spark Job Using Scalatest&description=&lt;p&gt;By nature, machine learning models that run on production need to deal with… well… data, presumably lots of them. There will be times that among many data that our model need to deal with, there will be bad ones. In which case, machine learning models tend to either immediately stop processing data, or continued on with processing and produce smelly result. The impact of both are bad.&lt;/p&gt;
&lt;p&gt;Unit testing ML models equip us as developers with an extra confidence to put models in production, by giving a way to an isolated modules in an ML pipeline to face various edge cases and try to handle them accordingly.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&t=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Environment-Setup"><span class="toc-number">1.</span> <span class="toc-text">Environment Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Funsuite-Test-Styles"><span class="toc-number">2.</span> <span class="toc-text">Funsuite Test Styles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Other-Test-Styles"><span class="toc-number">3.</span> <span class="toc-text">Other Test Styles</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Setting Up Unit Test for Your Apache Spark Job Using Scalatest
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Izzuddin Ahsanujunda</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-11-28T01:15:10.000Z" itemprop="datePublished">2020-11-28</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>By nature, machine learning models that run on production need to deal with… well… data, presumably lots of them. There will be times that among many data that our model need to deal with, there will be bad ones. In which case, machine learning models tend to either immediately stop processing data, or continued on with processing and produce smelly result. The impact of both are bad.</p>
<p>Unit testing ML models equip us as developers with an extra confidence to put models in production, by giving a way to an isolated modules in an ML pipeline to face various edge cases and try to handle them accordingly.</p>
<span id="more"></span>

<p>The idea is that by having an isolated modules handle edge cases correctly, they will work even better when put together in a pipeline. This will certainly minimize the amount of surprise encountered once the model is deployed.</p>
<p>Unit test also gave extra incentive to test by giving access to mocked input, means edge cases data can be artificially made without having to integrate with costly data sources (both in terms of money and compute resource).</p>
<p>This post explains how to set up unit testing environment and shows simple example of test cases, we are going to use <a target="_blank" rel="noopener" href="https://spark.apache.org/docs/latest/api/scala/org/apache/spark/index.html">Scala API</a> of Spark and Maven as build tool.</p>
<h2 id="Environment-Setup"><a href="#Environment-Setup" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p>First and foremost, we have to setup scalatest library in to our project. <a target="_blank" rel="noopener" href="https://www.scalatest.org/">Scalatest</a> supports many test styles, runners, and rich assertion library. It will make unit testing easier. We can setup scalatest using maven siply by adding the following lines to our <code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">&lt;!--  other dependencies--&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scalactic<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scalactic_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;scala.test.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scalatest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scalatest-funsuite_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;scala.test.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scalatest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scalatest-matchers-core_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;scala.test.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Do take note on <code>scalatest-funsuite</code> part of the configuration. This is the test style that we are going to use. I will explain a bit more about test styles later, so just take a note of this part for now.</p>
<p>Once the <code>pom.xml</code> has been set up, compile the project to let maven refreshes. It usually done by running <code>mvn clean package</code> command unless you have setup a custom maven build process.</p>
<h2 id="Funsuite-Test-Styles"><a href="#Funsuite-Test-Styles" class="headerlink" title="Funsuite Test Styles"></a>Funsuite Test Styles</h2><p>In this post, we use funsuite test style because it is the style that is used by Spark themselves, means if we are stuck and in need for inspiration, simply go to Spark project on github where it host tons of battle-tested test cases.</p>
<p>Now let’s imagine a function that will binarize a column based on a threshold number. Any number less than this number will be converted into 0s and the rest will be converted into 1s.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.iahsanujunda.spark.unitTest.example</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">DataFrame</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.functions._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Binarizer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(threshold: <span class="type">Int</span>, inputColName: <span class="type">String</span>)(df: <span class="type">DataFrame</span>): <span class="type">DataFrame</span> = &#123;</span><br><span class="line">    df.withColumn(</span><br><span class="line">        <span class="string">&quot;output&quot;</span>,</span><br><span class="line">        when(inputColName &lt; threshold, <span class="number">0</span>).otherwise(<span class="number">1</span>) </span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This function will work basically as follows.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// before</span><br><span class="line">+-----+--------+</span><br><span class="line">| <span class="built_in">id</span>  | metric |</span><br><span class="line">+-----+--------+</span><br><span class="line">| id1 |   2    |</span><br><span class="line">| id2 |   8    |</span><br><span class="line">| id3 |   1    |</span><br><span class="line">| id4 |   4    |</span><br><span class="line">| id5 |   2    |</span><br><span class="line">| id6 |   9    |</span><br><span class="line">+-----+--------+</span><br><span class="line"></span><br><span class="line">// with threshold = 5</span><br><span class="line">+-----+--------+--------+</span><br><span class="line">| <span class="built_in">id</span>  | metric | output |</span><br><span class="line">+-----+--------+--------|</span><br><span class="line">| id1 |   2    |   0    |</span><br><span class="line">| id2 |   8    |   1    |</span><br><span class="line">| id3 |   1    |   0    |</span><br><span class="line">| id4 |   4    |   0    |</span><br><span class="line">| id5 |   2    |   0    |</span><br><span class="line">| id6 |   9    |   1    |</span><br><span class="line">+-----+--------+--------+</span><br></pre></td></tr></table></figure>

<p>With funsuite style, test case for above scenario will look like this</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.iahsanujunda.spark.unitTest.example</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.scalatest.<span class="type">Matchers</span></span><br><span class="line"><span class="keyword">import</span> org.scalatest.funsuite.<span class="type">AnyFunSuite</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldSuite</span> <span class="keyword">extends</span> <span class="title">AnyFunSuite</span> <span class="keyword">with</span> <span class="title">Matchers</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    test(<span class="string">&quot;must correctly identify 0s and 1s&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">import</span> io.github.iahsanujunda.spark.unitTest.example.<span class="type">Binarizer</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">val</span> mockedDf = <span class="type">Seq</span>(</span><br><span class="line">            (<span class="string">&quot;id1&quot;</span>, <span class="number">2</span>)</span><br><span class="line">            (<span class="string">&quot;id2&quot;</span>, <span class="number">8</span>)</span><br><span class="line">            (<span class="string">&quot;id3&quot;</span>, <span class="number">1</span>)</span><br><span class="line">            (<span class="string">&quot;id4&quot;</span>, <span class="number">4</span>)</span><br><span class="line">            (<span class="string">&quot;id5&quot;</span>, <span class="number">2</span>)</span><br><span class="line">            (<span class="string">&quot;id6&quot;</span>, <span class="number">9</span>)</span><br><span class="line">        ).toDF(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;metric&quot;</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">val</span> result = mockedDf.transform(<span class="type">Binarizer</span>.process(<span class="number">5</span>, <span class="string">&quot;metric&quot;</span>))</span><br><span class="line">        <span class="keyword">val</span> zeros  = result.filter(<span class="string">&quot;output = 0&quot;</span>).select(<span class="string">&quot;id).collect.map(_(0))</span></span><br><span class="line"><span class="string">        val ones   = result.filter(&quot;</span>output = <span class="number">1</span><span class="string">&quot;).select(&quot;</span>id).collect.map(_(<span class="number">0</span>))</span><br><span class="line">        zeros should contain allOf (<span class="string">&quot;id1&quot;</span>, <span class="string">&quot;id3&quot;</span>, <span class="string">&quot;id4&quot;</span>, <span class="string">&quot;id5&quot;</span>)</span><br><span class="line">        ones should contain allOf (<span class="string">&quot;id2&quot;</span>, <span class="string">&quot;id6&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Easy isn’t it? Funsuite and Matchers allows us to write an easy-to-read test cases.</p>
<p>Now let’s say we want to add some extra functionality to our Binarizer. We want the output column to be configurable. Let’s write the test case first.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">test(<span class="string">&quot;must correctly produce configurable schema&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">import</span> io.github.iahsanujunda.spark.unitTest.example.<span class="type">Binarizer</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> mockedDf = <span class="type">Seq</span>(</span><br><span class="line">        (<span class="string">&quot;id1&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        (<span class="string">&quot;id2&quot;</span>, <span class="number">8</span>)</span><br><span class="line">        (<span class="string">&quot;id3&quot;</span>, <span class="number">1</span>)</span><br><span class="line">        (<span class="string">&quot;id4&quot;</span>, <span class="number">4</span>)</span><br><span class="line">        (<span class="string">&quot;id5&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        (<span class="string">&quot;id6&quot;</span>, <span class="number">9</span>)</span><br><span class="line">    ).toDF(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;metric&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> result = mockedDf.transform(<span class="type">Binarizer</span>.process(<span class="number">5</span>, <span class="string">&quot;metric&quot;</span>, <span class="string">&quot;binarized_column&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> schema = result.schema.fieldNames </span><br><span class="line">    schema should contain (<span class="string">&quot;binarized_column&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>When we run it now, it will fail, so we have to modify our Binarizer implementation as well.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Binarizer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(threshold: <span class="type">Int</span>, inputColName: <span class="type">String</span>, outputColName: <span class="type">String</span>)(df: <span class="type">DataFrame</span>): <span class="type">DataFrame</span> = &#123;</span><br><span class="line">    df.withColumn(</span><br><span class="line">        outputColName,</span><br><span class="line">        when(inputColName &lt; threshold, <span class="number">1</span>).otherwise(<span class="number">0</span>) </span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If we run the test case now, it will success. Wait… did we just casually summon TDD out of nowhere? Yes, we are. TDD is a very good software development practice. Considering we write our machine learning pipeline as a software, no harm in adding another jargon to our practice if it make our ML model better.</p>
<p>Now that we tackle the basic functionality, we can move on to an even richer test cases. What if we supply a column of strings as the input? Should we try to convert this string into number types if possible? or should we just throw an exception with a friendly advice to our fellow developer to please dont do that? What if we pass output column name that already exists in the dataframe? What if the threshold number appears as input, should it be 0 or should it be 1? We can think of lots and lots of edge cases, and we can be confident that when our model face these gangsters in production, it wont just pack up and run away.</p>
<p>If you need an inspiration on <strong>fantastic tests and how to find them</strong>, scalatest already wrote a comprehensive guide on the test styles and matcher objects. You can <a target="_blank" rel="noopener" href="https://www.scalatest.org/at_a_glance/FunSuite">check them out here</a>.</p>
<h2 id="Other-Test-Styles"><a href="#Other-Test-Styles" class="headerlink" title="Other Test Styles"></a>Other Test Styles</h2><p>Remember what I mentioned previously, that scalatest support various test style? Funsuite is just one of them. If you come from python world and already familiar with <code>unittest</code> library, you might find <a target="_blank" rel="noopener" href="https://www.scalatest.org/at_a_glance/PropSpec">PropSpec</a> style familiar. For those of you who come from Javascript world, <a target="_blank" rel="noopener" href="https://www.scalatest.org/at_a_glance/FunSpec">FunSpec</a> might be more of your cup.</p>
<p>When you decide to use another test style other than funsuite, then you should go back to <code>pom.xml</code> file above, and locate the <code>scalatest-funsuite</code> line. Change the <code>funsuite</code> part into the style of your choosing.</p>
<p>In the next part, I would try to explain how to organize our Spark project to have a clean and maintainable Spark code base.</p>
<p>Thanks for reading! I hope you gain something useful from this.</p>
<p>Stay safe, stay healthy~</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About-Me/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Environment-Setup"><span class="toc-number">1.</span> <span class="toc-text">Environment Setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Funsuite-Test-Styles"><span class="toc-number">2.</span> <span class="toc-text">Funsuite Test Styles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Other-Test-Styles"><span class="toc-number">3.</span> <span class="toc-text">Other Test Styles</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&text=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&is_video=false&description=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Setting Up Unit Test for Your Apache Spark Job Using Scalatest&body=Check out this article: https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&title=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&name=Setting Up Unit Test for Your Apache Spark Job Using Scalatest&description=&lt;p&gt;By nature, machine learning models that run on production need to deal with… well… data, presumably lots of them. There will be times that among many data that our model need to deal with, there will be bad ones. In which case, machine learning models tend to either immediately stop processing data, or continued on with processing and produce smelly result. The impact of both are bad.&lt;/p&gt;
&lt;p&gt;Unit testing ML models equip us as developers with an extra confidence to put models in production, by giving a way to an isolated modules in an ML pipeline to face various edge cases and try to handle them accordingly.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20201128/Setting-Up-Unit-Test-for-Your-Apache-Spark-Job-Using-Scalatest/&t=Setting Up Unit Test for Your Apache Spark Job Using Scalatest"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2022
    Izzuddin Ahsanujunda
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/About-Me/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'iahsanujunda/iahsanujunda.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
