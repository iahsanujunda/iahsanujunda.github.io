<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Previously, we have set up the main skeleton of our training pipeline using mlflow project and implemented a download step component. Now let’s continue building the training pipeline.  Right now we a">
<meta property="og:type" content="article">
<meta property="og:title" content="MLOps Part 2 - Feature Engineering and Training">
<meta property="og:url" content="https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/">
<meta property="og:site_name" content="Izzuddin Ahsanujunda Blog">
<meta property="og:description" content="Previously, we have set up the main skeleton of our training pipeline using mlflow project and implemented a download step component. Now let’s continue building the training pipeline.  Right now we a">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=17U78FW1bPP-wX-d1ipqczr-_AWxOz9T_">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1TvTLncVIr8iu-XjC3WlMefNUEK3EyNhZ">
<meta property="article:published_time" content="2021-09-14T16:00:18.000Z">
<meta property="article:modified_time" content="2022-08-09T02:26:40.992Z">
<meta property="article:author" content="Izzuddin Ahsanujunda">
<meta property="article:tag" content="mlops, machine-learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>MLOps Part 2 - Feature Engineering and Training</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/About-Me/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/20210802/MLOps-Part-1-Intro-to-MLflow-Project-and-setting-up-our-first-step/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&text=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&is_video=false&description=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MLOps Part 2 - Feature Engineering and Training&body=Check out this article: https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&name=MLOps Part 2 - Feature Engineering and Training&description=&lt;p&gt;Previously, we have set up the main skeleton of our training pipeline using mlflow project and implemented a &lt;code&gt;download&lt;/code&gt; step component. Now let’s continue building the training pipeline.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drive.google.com/uc?export=view&amp;id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;
&lt;p&gt;Right now we are going to develop the feature engineering and training part. For the sake of simplicity, we are going to implement a bare minimum feature engineering for our model, because we are looking to focus our work on mlops. It is very possible to develop a more rigorous feature engineering step that results in much better model performance.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&t=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-split-step"><span class="toc-number">1.</span> <span class="toc-text">Develop split step</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-train-model-step"><span class="toc-number">2.</span> <span class="toc-text">Develop train_model step</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MLOps Part 2 - Feature Engineering and Training
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Izzuddin Ahsanujunda</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-09-14T16:00:18.000Z" itemprop="datePublished">2021-09-14</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/mlops-machine-learning/" rel="tag">mlops, machine-learning</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Previously, we have set up the main skeleton of our training pipeline using mlflow project and implemented a <code>download</code> step component. Now let’s continue building the training pipeline.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r" alt="image"></p>
<p>Right now we are going to develop the feature engineering and training part. For the sake of simplicity, we are going to implement a bare minimum feature engineering for our model, because we are looking to focus our work on mlops. It is very possible to develop a more rigorous feature engineering step that results in much better model performance.</p>
<span id="more"></span>
<h2 id="Develop-split-step"><a href="#Develop-split-step" class="headerlink" title="Develop split step"></a>Develop split step</h2><p>Let’s start with creating a new file that will split our downloaded data on wandb into a training part and testing part.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch nyc_airbnb/split_train_test.py</span><br></pre></td></tr></table></figure>
<p>Just like <code>nyc_airbnb/get_data.py</code>, here we will build the logic to split our full dataset into a training and testing set. We do this early to safeguard our model from information leakage. Open the new file and put the following code into it.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;split_train_test.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"> </span><br><span class="line">sys.path.append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> nyc_airbnb.utils.base_runner <span class="keyword">import</span> BaseRunner</span><br><span class="line"> </span><br><span class="line">logging.basicConfig(</span><br><span class="line">   level=logging.INFO,</span><br><span class="line">   <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SplitRunner</span>(<span class="title class_ inherited__">BaseRunner</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                wandb_run,</span></span><br><span class="line"><span class="params">                test_size,</span></span><br><span class="line"><span class="params">                random_seed,</span></span><br><span class="line"><span class="params">                stratify_by</span>):</span><br><span class="line">       <span class="built_in">super</span>().__init__(wandb_run)</span><br><span class="line">       self.test_size = test_size</span><br><span class="line">       self.random_seed = random_seed</span><br><span class="line">       self.stratify_by = stratify_by</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">split_train_test</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                        data: pd.DataFrame,</span></span><br><span class="line"><span class="params">                        dir_name: <span class="built_in">str</span></span>):</span><br><span class="line">       trainval, test = train_test_split(</span><br><span class="line">           data,</span><br><span class="line">           test_size=<span class="built_in">float</span>(self.test_size),</span><br><span class="line">           random_state=<span class="built_in">int</span>(self.random_seed),</span><br><span class="line">           stratify=data[self.stratify_by] <span class="keyword">if</span> self.stratify_by != <span class="string">&#x27;none&#x27;</span> <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">       )</span><br><span class="line"> </span><br><span class="line">       logger.info(<span class="string">f&#x27;train proportion contains <span class="subst">&#123;trainval.shape[<span class="number">0</span>]&#125;</span>&#x27;</span>)</span><br><span class="line">       logger.info(<span class="string">f&#x27;test proportion contains <span class="subst">&#123;test.shape[<span class="number">0</span>]&#125;</span>&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">       file_dict = &#123;&#125;</span><br><span class="line">       <span class="keyword">for</span> data_frame, name <span class="keyword">in</span> <span class="built_in">zip</span>([trainval, test], [<span class="string">&#x27;trainval&#x27;</span>, <span class="string">&#x27;test&#x27;</span>]):</span><br><span class="line">           logger.info(<span class="string">f&quot;Uploading <span class="subst">&#123;name&#125;</span>_data.parquet dataset&quot;</span>)</span><br><span class="line">           temp_file = os.path.join(dir_name, <span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>_data.parquet&#x27;</span>)</span><br><span class="line">           data_frame.to_parquet(</span><br><span class="line">               temp_file,</span><br><span class="line">               index=<span class="literal">False</span>,</span><br><span class="line">               engine=<span class="string">&#x27;pyarrow&#x27;</span>,</span><br><span class="line">               compression=<span class="string">&#x27;gzip&#x27;</span>)</span><br><span class="line">           file_dict[<span class="string">f&#x27;<span class="subst">&#123;name&#125;</span>_data&#x27;</span>] = temp_file </span><br><span class="line"> </span><br><span class="line">       <span class="keyword">return</span> file_dict</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   parser = argparse.ArgumentParser(description=<span class="string">&quot;Split training dataset&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;input_artifact&quot;</span>,</span><br><span class="line">                       <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&quot;Reference to mlflow artifact of input data&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;test_size&quot;</span>,</span><br><span class="line">                       <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&quot;The size of test data&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;random_seed&quot;</span>,</span><br><span class="line">                       <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&quot;Random seed&quot;</span>)</span><br><span class="line">   parser.add_argument(<span class="string">&quot;stratify_by&quot;</span>,</span><br><span class="line">                       <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                       <span class="built_in">help</span>=<span class="string">&quot;Column to use for stratification&quot;</span>)</span><br><span class="line">   args = parser.parse_args()</span><br><span class="line"> </span><br><span class="line">   runner = SplitRunner(</span><br><span class="line">       wandb.init(job_type=<span class="string">&quot;split_data&quot;</span>),</span><br><span class="line">       args.test_size,</span><br><span class="line">       args.random_seed,</span><br><span class="line">       args.stratify_by</span><br><span class="line">   )</span><br><span class="line">   dataset = runner.retrieve_dataset_artifact(args.input_artifact)</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> temp_dir:</span><br><span class="line">       files = runner.split_train_test(dataset, temp_dir)</span><br><span class="line">       <span class="keyword">for</span> key, file_name <span class="keyword">in</span> files.items():</span><br><span class="line">           _ = runner.log_artifact(</span><br><span class="line">               <span class="string">f&#x27;<span class="subst">&#123;key&#125;</span>.parquet&#x27;</span>,</span><br><span class="line">               key,</span><br><span class="line">               <span class="string">f&#x27;<span class="subst">&#123;key&#125;</span> split of the dataset&#x27;</span>,</span><br><span class="line">               file_name</span><br><span class="line">           )</span><br><span class="line"> </span><br><span class="line">   sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>The logic here is quite simple, we listen for arguments of which artifact name from wandb we need to process. The actual artifact name will be supplied by the main entry point. We then download it, split it using sklearn’s <code>train_test_split</code>, and the result test and train split is logged back to wandb. The name of the artifact for both training portion and testing portion is also configurable, so that main entry point can further pass it on to the next component.</p>
<p>Now we have to strap this into <code>MLproject</code>.</p>
<blockquote>
<p>.&#x2F;MLproject</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">nyc_airbnb</span></span><br><span class="line"><span class="attr">conda_env:</span> <span class="string">conda.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">entry_points:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Comma-separated</span> <span class="string">list</span> <span class="string">of</span> <span class="string">steps</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">(useful</span> <span class="string">for</span> <span class="string">debugging)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">hydra_options:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Other</span> <span class="string">configuration</span> <span class="string">parameters</span> <span class="string">to</span> <span class="string">override</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python main.py main.steps=\\&#x27;&#123;steps&#125;\\&#x27; $(echo &#123;hydra_options&#125;)&quot;</span></span><br><span class="line">  <span class="attr">get_data:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">bucket:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">bucket</span> <span class="string">where</span> <span class="string">data</span> <span class="string">is</span> <span class="string">stored</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">object_path:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">object</span> <span class="string">of</span> <span class="string">dataset</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_name:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Name</span> <span class="string">for</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_type:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Type</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact.</span> <span class="string">This</span> <span class="string">will</span> <span class="string">be</span> <span class="string">used</span> <span class="string">to</span> <span class="string">categorize</span> <span class="string">the</span> <span class="string">artifact</span> <span class="string">in</span> <span class="string">the</span> <span class="string">W&amp;B</span> <span class="string">interface</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_description:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">A</span> <span class="string">brief</span> <span class="string">description</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/get_data.py</span></span><br><span class="line"><span class="string">        &#123;bucket&#125;</span></span><br><span class="line"><span class="string">        &#123;object_path&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_name&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_type&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_description&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">split:</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">input_artifact:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Artifact</span> <span class="string">to</span> <span class="string">split</span> <span class="string">(a</span> <span class="string">CSV</span> <span class="string">file)</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">test_size:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">test</span> <span class="string">split.</span> <span class="string">Fraction</span> <span class="string">of</span> <span class="string">the</span> <span class="string">dataset,</span> <span class="string">or</span> <span class="string">number</span> <span class="string">of</span> <span class="string">items</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">random_seed:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Seed</span> <span class="string">for</span> <span class="string">the</span> <span class="string">random</span> <span class="string">number</span> <span class="string">generator.</span> <span class="string">Use</span> <span class="string">this</span> <span class="string">for</span> <span class="string">reproducibility</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">default:</span> <span class="number">42</span></span><br><span class="line">    <span class="attr">stratify_by:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Column</span> <span class="string">to</span> <span class="string">use</span> <span class="string">for</span> <span class="string">stratification</span> <span class="string">(if</span> <span class="string">any)</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">&#x27;none&#x27;</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/split_train_test.py</span></span><br><span class="line"><span class="string">      &#123;input_artifact&#125;</span></span><br><span class="line"><span class="string">      &#123;test_size&#125;</span></span><br><span class="line"><span class="string">      &#123;random_seed&#125;</span></span><br><span class="line"><span class="string">      &#123;stratify_by&#125;&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>With <code>MLproject</code> entry point set, we can now call this from <code>main.py</code> with values retrieved from <code>config.yaml</code>.</p>
<blockquote>
<p>.&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">import</span> hydra</span><br><span class="line"><span class="keyword">from</span> omegaconf <span class="keyword">import</span> DictConfig</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_steps = [</span><br><span class="line">    <span class="string">&#x27;download&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;split&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This decorator automatically reads in the configuration</span></span><br><span class="line"><span class="meta">@hydra.main(<span class="params">config_name=<span class="string">&#x27;config&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go</span>(<span class="params">config: DictConfig</span>):</span><br><span class="line">    <span class="comment"># Setup the wandb experiment. All runs will be grouped under this name</span></span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;project_name&quot;</span>]</span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_RUN_GROUP&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;experiment_name&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Steps to execute</span></span><br><span class="line">    steps_par = config[<span class="string">&#x27;main&#x27;</span>][<span class="string">&#x27;steps&#x27;</span>]</span><br><span class="line">    active_steps = steps_par.split(<span class="string">&quot;,&quot;</span>) <span class="keyword">if</span> steps_par != <span class="string">&quot;all&quot;</span> <span class="keyword">else</span> _steps</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Move to a temporary directory</span></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;download&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            <span class="comment"># Download file and load in W&amp;B</span></span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                hydra.utils.get_original_cwd(),</span><br><span class="line">                <span class="string">&quot;get_data&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;bucket&quot;</span>: config[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;bucket&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;object_path&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_type&quot;</span>: <span class="string">&quot;raw_data&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_description&quot;</span>: <span class="string">&quot;Raw dataset from data store&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> <span class="string">&quot;split&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                hydra.utils.get_original_cwd(),</span><br><span class="line">                <span class="string">&quot;split&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;input_artifact&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;test_size&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;test_size&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;random_seed&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;random_seed&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;stratify_by&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;stratify_by&#x27;</span>],</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    go()</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>.&#x2F;config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">project_name:</span> <span class="string">&quot;nyc_airbnb&quot;</span></span><br><span class="line">  <span class="attr">experiment_name:</span> <span class="string">&quot;random_forest_model&quot;</span></span><br><span class="line">  <span class="attr">steps:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">&quot;junda-mlops&quot;</span></span><br><span class="line">  <span class="attr">object:</span> <span class="string">&quot;dataset/training_data/&quot;</span></span><br><span class="line">  <span class="attr">raw_data:</span> <span class="string">&quot;raw_training_data.parquet&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modeling:</span></span><br><span class="line">  <span class="comment"># Fraction of data to use for test (the remaining will be used for train and validation)</span></span><br><span class="line">  <span class="attr">test_size:</span> <span class="number">0.2</span></span><br><span class="line">  <span class="comment"># Fraction of remaining data to use for validation</span></span><br><span class="line">  <span class="attr">val_size:</span> <span class="number">0.2</span></span><br><span class="line">  <span class="comment"># Fix this for reproducibility, change to have new splits</span></span><br><span class="line">  <span class="attr">random_seed:</span> <span class="number">42</span></span><br><span class="line">  <span class="comment"># Column to use for stratification (use &quot;none&quot; for no stratification)</span></span><br><span class="line">  <span class="attr">stratify_by:</span> <span class="string">&quot;none&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>With this we have set up the split step and we can test run this. We can either run entire pipeline, or just the <code>split</code> part. This is made possible because we pass <code>raw_data.parquet:latest</code> as an argument to <code>split</code> entry point. The <code>:latest</code> tag means we will always retrieve the most recent version of the file. If we have multiple version of our wadnb artifact, we can also pass the specific version as tag, such as <code>v0</code> for the first ever logged version of that particular artifact, or <code>v1</code> for the second version, etc.</p>
<p>To run only this component step, use <code>mlflow run . -P steps=split</code>. To run the entire pipeline, the command is <code>mlflow run .</code>.</p>
<p>After the run is finished, check our wandb dashboard and see if a new artifact called <code>trainval_data</code> and <code>test_data</code> exists. Both of these will be passed to subsequent steps.</p>
<p><img src="https://drive.google.com/uc?export=view&id=17U78FW1bPP-wX-d1ipqczr-_AWxOz9T_" alt="wandb dasboard"></p>
<h2 id="Develop-train-model-step"><a href="#Develop-train-model-step" class="headerlink" title="Develop train_model step"></a>Develop train_model step</h2><p>Let’s put in the logic for training our model. Create a new file for this.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch nyc_airbnb/train.py</span><br></pre></td></tr></table></figure>
<p>And paste in the following code.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;train.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> r2_score, mean_absolute_error</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> nyc_airbnb.utils.base_runner <span class="keyword">import</span> BaseRunner</span><br><span class="line"><span class="keyword">from</span> nyc_airbnb.utils.pipeline <span class="keyword">import</span> get_inference_pipeline</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TrainModelRunner</span>(<span class="title class_ inherited__">BaseRunner</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 wandb_run,</span></span><br><span class="line"><span class="params">                 label,</span></span><br><span class="line"><span class="params">                 random_seed,</span></span><br><span class="line"><span class="params">                 stratify_by,</span></span><br><span class="line"><span class="params">                 val_size</span></span><br><span class="line"><span class="params">                 </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(wandb_run)</span><br><span class="line">        self.label = label</span><br><span class="line">        self.val_size = val_size</span><br><span class="line">        self.stratify_by = stratify_by</span><br><span class="line">        self.random_seed = random_seed</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">              data: pd.DataFrame,</span></span><br><span class="line"><span class="params">              rf_config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>],</span></span><br><span class="line"><span class="params">              max_tfidf_features</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Train a model by running fit() method of pipeline.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            data: A DataFrame of training dataset</span></span><br><span class="line"><span class="string">            rf_config:</span></span><br><span class="line"><span class="string">                A configuration dict to be used as model parameters</span></span><br><span class="line"><span class="string">            max_tfidf_features:</span></span><br><span class="line"><span class="string">                hyper-param for tfidf preprocessor</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        y = data[self.label]</span><br><span class="line">        X = data.drop(self.label, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        X_train, X_val, y_train, y_val = train_test_split(</span><br><span class="line">            X,</span><br><span class="line">            y,</span><br><span class="line">            test_size=self.val_size,</span><br><span class="line">            stratify=X[self.stratify_by],</span><br><span class="line">            random_state=self.random_seed</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Preparing pipeline&quot;</span>)</span><br><span class="line">        lasso_pipe = get_inference_pipeline(</span><br><span class="line">            rf_config,</span><br><span class="line">            max_tfidf_features</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Training model&quot;</span>)</span><br><span class="line">        trained_model = lasso_pipe.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># training performance metric</span></span><br><span class="line">        y_pred = trained_model.predict(X)</span><br><span class="line">        r2 = r2_score(y, y_pred)</span><br><span class="line">        mae = mean_absolute_error(y, y_pred)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> r2, mae, trained_model</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">persist_model</span>(<span class="params">self, model, model_artifact_name: <span class="built_in">str</span></span>):</span><br><span class="line">        persist_dir = <span class="string">f&#x27;<span class="subst">&#123;model_artifact_name&#125;</span>_dir&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove if exists</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(persist_dir):</span><br><span class="line">            shutil.rmtree(persist_dir)</span><br><span class="line"></span><br><span class="line">        mlflow.sklearn.save_model(</span><br><span class="line">            model,</span><br><span class="line">            persist_dir,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.log_model(</span><br><span class="line">            model_artifact_name,</span><br><span class="line">            <span class="string">&quot;model_export&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Pytorch lasso model export&quot;</span>,</span><br><span class="line">            persist_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Process arguments</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;Train the model&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;trainval_artifact&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Artifact containing the training dataset. It will be split into train and validation&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;val_size&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">float</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Size of the validation split. Fraction of the dataset, or number of items&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;random_seed&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Seed for random number generator&quot;</span>,</span><br><span class="line">        default=<span class="number">42</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;stratify_by&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Column to use for stratification&quot;</span>,</span><br><span class="line">        default=<span class="string">&quot;none&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;rf_config&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Random forest configuration. A JSON dict that will be passed to the &quot;</span></span><br><span class="line">             <span class="string">&quot;scikit-learn constructor for RandomForestRegressor.&quot;</span>,</span><br><span class="line">        default=<span class="string">&quot;&#123;&#125;&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;max_tfidf_features&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Maximum number of words to consider for the TFIDF&quot;</span>,</span><br><span class="line">        default=<span class="number">10</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">int</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;output_artifact&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Name for the output serialized model&quot;</span></span><br><span class="line">    )</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    wandb_run = wandb.init(job_type=<span class="string">&quot;training_model&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(args.rf_config) <span class="keyword">as</span> fp:</span><br><span class="line">        rf_config = json.load(fp)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Log model config to wandb runs</span></span><br><span class="line">    wandb_run.config.update(rf_config)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run training</span></span><br><span class="line">    runner = TrainModelRunner(</span><br><span class="line">        wandb_run,</span><br><span class="line">        label=args.label</span><br><span class="line">    )</span><br><span class="line">    training_set = runner.retrieve_dataset_artifact(args.train_artifact)</span><br><span class="line">    r2, mae, TRAINED_MODEL = runner.train(training_set, rf_config, args.max_tfidf_features)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Logging to wandb</span></span><br><span class="line">    logger.info(<span class="string">f&#x27;R2 score is <span class="subst">&#123;r2&#125;</span>&#x27;</span>)</span><br><span class="line">    logger.info(<span class="string">f&#x27;MAE loss is <span class="subst">&#123;mae&#125;</span>&#x27;</span>)</span><br><span class="line">    wandb_run.summary[<span class="string">&#x27;Training r2&#x27;</span>] = r2</span><br><span class="line">    wandb_run.log(&#123;</span><br><span class="line">        <span class="string">&quot;Training mae&quot;</span>: mae,</span><br><span class="line">        <span class="string">&quot;Training r2&quot;</span>: r2</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Persist model</span></span><br><span class="line">    logger.info(<span class="string">&#x27;Exporting model&#x27;</span>)</span><br><span class="line">    runner.persist_model(TRAINED_MODEL, args.output_artifact)</span><br><span class="line"></span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>In this step, we are going to train our model on the training split of the data. We score the performance on the model on <em>training</em> data, and log the trained model artifact and the performance into wandb. Later on, we are going use the same trained model artfact to score to <em>testing</em> data. Doing this gave us several advantage:</p>
<ol>
<li>It safeguards us from data leakage. Remember that we split our dataset immediately after retrieving them from source, any cleaning&#x2F;preprocessing we do in this step will only be applied to training split of the data.</li>
<li>Scoring separately allows us to safeguard from overfitting. We might apply cross-validation in our training step to discover the most optimal combination of hyperparameters and preprocessing logic, and the same hyperparameter and preprocessing will be applied upon testing data that we haven’t seen at all during training. This will allow us to prepare our model to deal with new data in production.</li>
</ol>
<p>We are also going to organise the source code in a way that is easy to maintain and extend. Here we are only going to retrieve training data and slap it into the training pipeline. The actual training and preprocessing logic will be built on different modules. This way, we may plug-in and plug-out any preprocessing logic or even swap out the model from logistic regression into gradient boosting, the training function here won’t care as long as it can get the pipeline object.</p>
<p>To achieve this, we need to create the <code>get_inference_pipeline</code> function; it will return a scikit-learn compatible <code>Pipeline</code> object. <code>Pipeline</code> can assemble multiple estimators and transformers together. If we need to apply <code>OneHotEncoding</code>, <code>StandardScaler</code> and <code>RandomForest</code> together, we put them into a <code>Pipeline</code> and we can all <code>fit</code> only once from the <code>Pipeline</code>. The <code>Pipeline</code> will be the ones handling <code>fit</code> execution in sequence. When we want to save these fitted estimators together, we just need to save the <code>Pipeline</code>.</p>
<p>Create the module to store our <code>Pipeline</code> logic.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch nyc_airbnb/utils/pipeline.py</span><br></pre></td></tr></table></figure>
<p>Write the following code into the new file.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;utils&#x2F;pipeline.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.compose <span class="keyword">import</span> ColumnTransformer</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.impute <span class="keyword">import</span> SimpleImputer</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> OrdinalEncoder, OneHotEncoder, FunctionTransformer</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline, make_pipeline</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delta_date_feature</span>(<span class="params">dates</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given a 2d array containing dates (in any format recognized by pd.to_datetime), it returns the delta in days</span></span><br><span class="line"><span class="string">    between each date and the most recent date in its column</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    date_sanitized = pd.DataFrame(dates).apply(pd.to_datetime)</span><br><span class="line">    <span class="keyword">return</span> date_sanitized.apply(<span class="keyword">lambda</span> d: (d.<span class="built_in">max</span>() - d).dt.days, axis=<span class="number">0</span>).to_numpy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_inference_pipeline</span>(<span class="params">rf_config, max_tfidf_features</span>):</span><br><span class="line">    <span class="comment"># Let&#x27;s handle the categorical features first</span></span><br><span class="line">    <span class="comment"># Ordinal categorical are categorical values for which the order is meaningful, for example</span></span><br><span class="line">    <span class="comment"># for room type: &#x27;Entire home/apt&#x27; &gt; &#x27;Private room&#x27; &gt; &#x27;Shared room&#x27;</span></span><br><span class="line">    ordinal_categorical = [<span class="string">&quot;room_type&quot;</span>]</span><br><span class="line">    non_ordinal_categorical = [<span class="string">&quot;neighbourhood_group&quot;</span>]</span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> we do not need to impute room_type because the type of the room</span></span><br><span class="line">    <span class="comment"># is mandatory on the websites, so missing values are not possible in production</span></span><br><span class="line">    <span class="comment"># (nor during training). That is not true for neighbourhood_group</span></span><br><span class="line">    ordinal_categorical_preproc = OrdinalEncoder()</span><br><span class="line"></span><br><span class="line">    <span class="comment">######################################</span></span><br><span class="line">    <span class="comment"># Build a pipeline with two steps:</span></span><br><span class="line">    <span class="comment"># 1 - A SimpleImputer(strategy=&quot;most_frequent&quot;) to impute missing values</span></span><br><span class="line">    <span class="comment"># 2 - A OneHotEncoder() step to encode the variable</span></span><br><span class="line">    non_ordinal_categorical_preproc = make_pipeline(</span><br><span class="line">        SimpleImputer(strategy=<span class="string">&quot;most_frequent&quot;</span>),</span><br><span class="line">        OneHotEncoder()</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">######################################</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Let&#x27;s impute the numerical columns to make sure we can handle missing values</span></span><br><span class="line">    <span class="comment"># (note that we do not scale because the RF algorithm does not need that)</span></span><br><span class="line">    zero_imputed = [</span><br><span class="line">        <span class="string">&quot;minimum_nights&quot;</span>,</span><br><span class="line">        <span class="string">&quot;number_of_reviews&quot;</span>,</span><br><span class="line">        <span class="string">&quot;reviews_per_month&quot;</span>,</span><br><span class="line">        <span class="string">&quot;calculated_host_listings_count&quot;</span>,</span><br><span class="line">        <span class="string">&quot;availability_365&quot;</span>,</span><br><span class="line">        <span class="string">&quot;longitude&quot;</span>,</span><br><span class="line">        <span class="string">&quot;latitude&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    zero_imputer = SimpleImputer(strategy=<span class="string">&quot;constant&quot;</span>, fill_value=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># A MINIMAL FEATURE ENGINEERING step:</span></span><br><span class="line">    <span class="comment"># we create a feature that represents the number of days passed since the last review</span></span><br><span class="line">    <span class="comment"># First we impute the missing review date with an old date (because there hasn&#x27;t been</span></span><br><span class="line">    <span class="comment"># a review for a long time), and then we create a new feature from it,</span></span><br><span class="line">    date_imputer = make_pipeline(</span><br><span class="line">        SimpleImputer(missing_values=<span class="literal">None</span>, strategy=<span class="string">&#x27;constant&#x27;</span>, fill_value=<span class="string">&#x27;2010-01-01&#x27;</span>),</span><br><span class="line">        FunctionTransformer(delta_date_feature, check_inverse=<span class="literal">False</span>, validate=<span class="literal">False</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Some minimal NLP for the &quot;name&quot; column</span></span><br><span class="line">    reshape_to_1d = FunctionTransformer(np.reshape, kw_args=&#123;<span class="string">&quot;newshape&quot;</span>: -<span class="number">1</span>&#125;)</span><br><span class="line">    name_tfidf = make_pipeline(</span><br><span class="line">        SimpleImputer(missing_values=<span class="literal">None</span>, strategy=<span class="string">&quot;constant&quot;</span>, fill_value=<span class="string">&quot;imputed name&quot;</span>),</span><br><span class="line">        reshape_to_1d,</span><br><span class="line">        TfidfVectorizer(</span><br><span class="line">            binary=<span class="literal">False</span>,</span><br><span class="line">            max_features=max_tfidf_features,</span><br><span class="line">            stop_words=<span class="string">&#x27;english&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Let&#x27;s put everything together</span></span><br><span class="line">    preprocessor = ColumnTransformer(</span><br><span class="line">        transformers=[</span><br><span class="line">            (<span class="string">&quot;ordinal_cat&quot;</span>, ordinal_categorical_preproc, ordinal_categorical),</span><br><span class="line">            (<span class="string">&quot;non_ordinal_cat&quot;</span>, non_ordinal_categorical_preproc, non_ordinal_categorical),</span><br><span class="line">            (<span class="string">&quot;impute_zero&quot;</span>, zero_imputer, zero_imputed),</span><br><span class="line">            (<span class="string">&quot;transform_date&quot;</span>, date_imputer, [<span class="string">&quot;last_review&quot;</span>]),</span><br><span class="line">            (<span class="string">&quot;transform_name&quot;</span>, name_tfidf, [<span class="string">&quot;name&quot;</span>])</span><br><span class="line">        ],</span><br><span class="line">        remainder=<span class="string">&quot;drop&quot;</span>,  <span class="comment"># This drops the columns that we do not transform</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    processed_features = ordinal_categorical + non_ordinal_categorical + zero_imputed + [<span class="string">&quot;last_review&quot;</span>, <span class="string">&quot;name&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create random forest</span></span><br><span class="line">    random_forest = RandomForestRegressor(**rf_config)</span><br><span class="line"></span><br><span class="line">    <span class="comment">######################################</span></span><br><span class="line">    <span class="comment"># Create the inference pipeline. The pipeline must have 2 steps: a step called &quot;preprocessor&quot; applying the</span></span><br><span class="line">    <span class="comment"># ColumnTransformer instance that we saved in the `preprocessor` variable, and a step called &quot;random_forest&quot;</span></span><br><span class="line">    <span class="comment"># with the random forest instance that we just saved in the `random_forest` variable.</span></span><br><span class="line">    <span class="comment"># HINT: Use the explicit Pipeline instead of make_pipeline constructor to leverage named step</span></span><br><span class="line">    sk_pipe = Pipeline(</span><br><span class="line">        steps=[</span><br><span class="line">            (<span class="string">&quot;preprocessor&quot;</span>, preprocessor),</span><br><span class="line">            (<span class="string">&quot;random_forest&quot;</span>, random_forest)</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sk_pipe, processed_features</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>Here we declare all preprocessing logic for each data type, ordinal categorical, nominal categorical, numeric, temporal, and textual. We strap all of these with <code>ColumnTransformer</code>, and the resulting transformer can be put into a <code>Pipeline</code> step. The final pipeline just needs to combine the <code>preprocessor</code> step and <code>random_forest</code> model.</p>
<p>As we can see, we build the steps in a declarative way, so we can change any part of the steps and it can be called by our <code>train</code> entry point as long as we return <code>Pipeline</code> from here.</p>
<p>Now that we have created the entry point for training, we just have to call it from our main entry point. Let’s start by making the entry point for training in our MLproject.</p>
<blockquote>
<p>.&#x2F;MLproject</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">nyc_airbnb</span></span><br><span class="line"><span class="attr">conda_env:</span> <span class="string">conda.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">entry_points:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Comma-separated</span> <span class="string">list</span> <span class="string">of</span> <span class="string">steps</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">(useful</span> <span class="string">for</span> <span class="string">debugging)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">hydra_options:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Other</span> <span class="string">configuration</span> <span class="string">parameters</span> <span class="string">to</span> <span class="string">override</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python main.py main.steps=\\&#x27;&#123;steps&#125;\\&#x27; $(echo &#123;hydra_options&#125;)&quot;</span></span><br><span class="line">  <span class="attr">get_data:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">bucket:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">bucket</span> <span class="string">where</span> <span class="string">data</span> <span class="string">is</span> <span class="string">stored</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">object_path:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">object</span> <span class="string">of</span> <span class="string">dataset</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_name:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Name</span> <span class="string">for</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_type:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Type</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact.</span> <span class="string">This</span> <span class="string">will</span> <span class="string">be</span> <span class="string">used</span> <span class="string">to</span> <span class="string">categorize</span> <span class="string">the</span> <span class="string">artifact</span> <span class="string">in</span> <span class="string">the</span> <span class="string">W&amp;B</span> <span class="string">interface</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_description:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">A</span> <span class="string">brief</span> <span class="string">description</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/get_data.py</span></span><br><span class="line"><span class="string">        &#123;bucket&#125;</span></span><br><span class="line"><span class="string">        &#123;object_path&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_name&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_type&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_description&#125;&quot;</span></span><br><span class="line">  <span class="attr">split:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">input_artifact:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Artifact</span> <span class="string">to</span> <span class="string">split</span> <span class="string">(a</span> <span class="string">CSV</span> <span class="string">file)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">test_size:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">test</span> <span class="string">split.</span> <span class="string">Fraction</span> <span class="string">of</span> <span class="string">the</span> <span class="string">dataset,</span> <span class="string">or</span> <span class="string">number</span> <span class="string">of</span> <span class="string">items</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">random_seed:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Seed</span> <span class="string">for</span> <span class="string">the</span> <span class="string">random</span> <span class="string">number</span> <span class="string">generator.</span> <span class="string">Use</span> <span class="string">this</span> <span class="string">for</span> <span class="string">reproducibility</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">default:</span> <span class="number">42</span></span><br><span class="line">      <span class="attr">stratify_by:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Column</span> <span class="string">to</span> <span class="string">use</span> <span class="string">for</span> <span class="string">stratification</span> <span class="string">(if</span> <span class="string">any)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/split_train_test.py</span></span><br><span class="line"><span class="string">        &#123;input_artifact&#125;</span></span><br><span class="line"><span class="string">        &#123;test_size&#125;</span></span><br><span class="line"><span class="string">        &#123;random_seed&#125;</span></span><br><span class="line"><span class="string">        &#123;stratify_by&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">label:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Label</span> <span class="string">column</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">trainval_artifact:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Train</span> <span class="string">dataset</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">val_size:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">validation</span> <span class="string">split.</span> <span class="string">Fraction</span> <span class="string">of</span> <span class="string">the</span> <span class="string">dataset,</span> <span class="string">or</span> <span class="string">number</span> <span class="string">of</span> <span class="string">items</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">random_seed:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Seed</span> <span class="string">for</span> <span class="string">the</span> <span class="string">random</span> <span class="string">number</span> <span class="string">generator.</span> <span class="string">Use</span> <span class="string">this</span> <span class="string">for</span> <span class="string">reproducibility</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">default:</span> <span class="number">42</span></span><br><span class="line">    <span class="attr">stratify_by:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Column</span> <span class="string">to</span> <span class="string">use</span> <span class="string">for</span> <span class="string">stratification</span> <span class="string">(if</span> <span class="string">any)</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    <span class="attr">rf_config:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Random</span> <span class="string">forest</span> <span class="string">configuration.</span> <span class="string">A</span> <span class="string">path</span> <span class="string">to</span> <span class="string">a</span> <span class="string">JSON</span> <span class="string">file</span> <span class="string">with</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">that</span> <span class="string">will</span></span><br><span class="line">                  <span class="string">be</span> <span class="string">passed</span> <span class="string">to</span> <span class="string">the</span> <span class="string">scikit-learn</span> <span class="string">constructor</span> <span class="string">for</span> <span class="string">RandomForestRegressor.</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">max_tfidf_features:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">words</span> <span class="string">to</span> <span class="string">consider</span> <span class="string">for</span> <span class="string">the</span> <span class="string">TFIDF</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">output_artifact:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Name</span> <span class="string">for</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/train.py</span></span><br><span class="line"><span class="string">      &#123;label&#125;</span></span><br><span class="line"><span class="string">      &#123;trainval_artifact&#125;</span></span><br><span class="line"><span class="string">      &#123;val_size&#125;</span></span><br><span class="line"><span class="string">      &#123;random_seed&#125;</span></span><br><span class="line"><span class="string">      &#123;stratify_by&#125;</span></span><br><span class="line"><span class="string">      &#123;rf_config&#125;</span></span><br><span class="line"><span class="string">      &#123;max_tfidf_features&#125;</span></span><br><span class="line"><span class="string">      &#123;output_artifact&#125;&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>Now we can call this from <code>main.py</code>.</p>
<blockquote>
<p>.&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">import</span> hydra</span><br><span class="line"><span class="keyword">from</span> omegaconf <span class="keyword">import</span> DictConfig</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_steps = [</span><br><span class="line">    <span class="string">&#x27;download&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;split&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This decorator automatically reads in the configuration</span></span><br><span class="line"><span class="meta">@hydra.main(<span class="params">config_name=<span class="string">&#x27;config&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go</span>(<span class="params">config: DictConfig</span>):</span><br><span class="line">    <span class="comment"># Setup the wandb experiment. All runs will be grouped under this name</span></span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;project_name&quot;</span>]</span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_RUN_GROUP&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;experiment_name&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Steps to execute</span></span><br><span class="line">    steps_par = config[<span class="string">&#x27;main&#x27;</span>][<span class="string">&#x27;steps&#x27;</span>]</span><br><span class="line">    active_steps = steps_par.split(<span class="string">&quot;,&quot;</span>) <span class="keyword">if</span> steps_par != <span class="string">&quot;all&quot;</span> <span class="keyword">else</span> _steps</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Move to a temporary directory</span></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;download&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            <span class="comment"># Download file and load in W&amp;B</span></span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                hydra.utils.get_original_cwd(),</span><br><span class="line">                <span class="string">&quot;get_data&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;bucket&quot;</span>: config[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;bucket&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;object_path&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_type&quot;</span>: <span class="string">&quot;raw_data&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_description&quot;</span>: <span class="string">&quot;Raw dataset from data store&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;split&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                hydra.utils.get_original_cwd(),</span><br><span class="line">                <span class="string">&quot;split&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;input_artifact&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;test_size&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;test_size&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;random_seed&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;random_seed&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;stratify_by&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;stratify_by&#x27;</span>],</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">         <span class="keyword">if</span> <span class="string">&quot;train&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            <span class="comment"># <span class="doctag">NOTE:</span> we need to serialize the random forest configuration into JSON</span></span><br><span class="line">            rf_config = os.path.abspath(<span class="string">&quot;rf_config.json&quot;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(rf_config, <span class="string">&quot;w+&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                json.dump(<span class="built_in">dict</span>(config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;random_forest&quot;</span>].items()), fp)  <span class="comment"># DO NOT TOUCH</span></span><br><span class="line">            <span class="comment"># <span class="doctag">NOTE:</span> use the rf_config we just created as the rf_config parameter for the train_random_forest</span></span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                os.path.join(hydra.utils.get_original_cwd()),</span><br><span class="line">                <span class="string">&quot;train&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;label&quot;</span>: config[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;label&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;trainval_artifact&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;training_data&#x27;</span>]&#125;</span>:latest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;val_size&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;val_size&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;random_seed&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;random_seed&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;stratify_by&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;stratify_by&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;rf_config&quot;</span>: rf_config,</span><br><span class="line">                    <span class="string">&quot;max_tfidf_features&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;max_tfidf_features&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;output_artifact&quot;</span>: <span class="string">&quot;random_forest_export&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    go()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Before we finish the training part and test run this, we need to add the configuration in <code>config.yaml</code>.</p>
<blockquote>
<p>.&#x2F;config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">project_name:</span> <span class="string">&quot;nyc_airbnb&quot;</span></span><br><span class="line">  <span class="attr">experiment_name:</span> <span class="string">&quot;random_forest_model&quot;</span></span><br><span class="line">  <span class="attr">steps:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">&quot;junda-mlops&quot;</span></span><br><span class="line">  <span class="attr">object:</span> <span class="string">&quot;dataset/training_data/&quot;</span></span><br><span class="line">  <span class="attr">raw_data:</span> <span class="string">&quot;raw_training_data.parquet&quot;</span></span><br><span class="line">  <span class="attr">training_data:</span> <span class="string">&quot;trainval_data.parquet&quot;</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line"><span class="attr">modeling:</span></span><br><span class="line">  <span class="comment"># Fraction of data to use for test (the remaining will be used for train and validation)</span></span><br><span class="line">  <span class="attr">test_size:</span> <span class="number">0.2</span></span><br><span class="line">  <span class="comment"># Fraction of remaining data to use for validation</span></span><br><span class="line">  <span class="attr">val_size:</span> <span class="number">0.2</span></span><br><span class="line">  <span class="comment"># Fix this for reproducibility, change to have new splits</span></span><br><span class="line">  <span class="attr">random_seed:</span> <span class="number">42</span></span><br><span class="line">  <span class="comment"># Column to use for stratification (use &quot;none&quot; for no stratification)</span></span><br><span class="line">  <span class="attr">stratify_by:</span> <span class="string">&quot;none&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">max_tfidf_features:</span> <span class="number">15</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> you can put here any parameter that is accepted by the constructor of</span></span><br><span class="line"><span class="comment"># RandomForestRegressor. This is a subsample, but more could be added:</span></span><br><span class="line"><span class="attr">random_forest:</span></span><br><span class="line">  <span class="attr">n_estimators:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">max_depth:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">min_samples_split:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">min_samples_leaf:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># Here -1 means all available cores</span></span><br><span class="line">  <span class="attr">n_jobs:</span> <span class="number">-1</span></span><br><span class="line">  <span class="attr">criterion:</span> <span class="string">mae</span></span><br><span class="line">  <span class="attr">max_features:</span> <span class="number">0.5</span></span><br><span class="line">  <span class="comment"># DO not change the following</span></span><br><span class="line">  <span class="attr">oob_score:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>Now we have everything ready to test run our training step. Same as previous example, we can run using mlflow cli.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlflow run . -P steps=train</span><br></pre></td></tr></table></figure>

<p>If we look at wandb.ai run summary, we are going to see training score of our model.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1TvTLncVIr8iu-XjC3WlMefNUEK3EyNhZ" alt="wandb ss"></p>
<p>Not only that, we can also see the hyper parameter we use to get that score, the datasets we consume, and their respective version. This is going to be very useful when we want to do offline evaluation of our model.</p>
<p>The progress up to this point can be accessed from the <a target="_blank" rel="noopener" href="https://github.com/iahsanujunda/nyc_airbnb_pipeline">accompanying repository</a> on <code>part-2</code> branch.</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About-Me/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-split-step"><span class="toc-number">1.</span> <span class="toc-text">Develop split step</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-train-model-step"><span class="toc-number">2.</span> <span class="toc-text">Develop train_model step</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&text=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&is_video=false&description=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MLOps Part 2 - Feature Engineering and Training&body=Check out this article: https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&title=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&name=MLOps Part 2 - Feature Engineering and Training&description=&lt;p&gt;Previously, we have set up the main skeleton of our training pipeline using mlflow project and implemented a &lt;code&gt;download&lt;/code&gt; step component. Now let’s continue building the training pipeline.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drive.google.com/uc?export=view&amp;id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;
&lt;p&gt;Right now we are going to develop the feature engineering and training part. For the sake of simplicity, we are going to implement a bare minimum feature engineering for our model, because we are looking to focus our work on mlops. It is very possible to develop a more rigorous feature engineering step that results in much better model performance.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/&t=MLOps Part 2 - Feature Engineering and Training"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2022
    Izzuddin Ahsanujunda
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/About-Me/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'iahsanujunda/iahsanujunda.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
