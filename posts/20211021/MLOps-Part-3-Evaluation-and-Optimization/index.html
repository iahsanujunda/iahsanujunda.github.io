<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Now that we have trained a model and store it as a reusable artifact, we are ready to evaluate the model on unseen data. As with usual training practice, we are going to pull out the test portion of o">
<meta property="og:type" content="article">
<meta property="og:title" content="MLOps Part 3 - Evaluation and Optimization">
<meta property="og:url" content="https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/">
<meta property="og:site_name" content="Izzuddin Ahsanujunda Blog">
<meta property="og:description" content="Now that we have trained a model and store it as a reusable artifact, we are ready to evaluate the model on unseen data. As with usual training practice, we are going to pull out the test portion of o">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1WUKB5kZDA3Fxp55exCOA9nFBg2f-M9dV">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1pXGQt1VMu6b8uMs3Y0xfOSuQ0ROU4laL">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1BcZet0aZFdOaDgCGy385RG7j9ZwI2qrs">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1bvvNk39nZ74ZrxGrhC44CbG13yLryUqy">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=11wbp_dUyZUiHGScY5GkFP0sWaj-NZayW">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1Cqv2Uzt8Srp-i9dTHR8Lq6jxA__YaMfq">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1T3umZFxiGYo6LnSjNTOiqlbMrmHdfRAm">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1ndvWMeNmwfbRIz4TUVC6sSzfFMboG6hL">
<meta property="og:image" content="https://drive.google.com/uc?export=view&id=1FKMrCMYCjzjQ0uKRCXH1zTLEgpDLzwVk">
<meta property="article:published_time" content="2021-10-21T04:57:21.000Z">
<meta property="article:modified_time" content="2023-01-09T06:36:54.551Z">
<meta property="article:author" content="Izzuddin Ahsanujunda">
<meta property="article:tag" content="mlops, machine-learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>MLOps Part 3 - Evaluation and Optimization</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/About-Me/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/20220730/Does-FromSoft-explicitly-program-Malenia-to-skip-waterfowl-dance/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/20210914/MLOps-Part-2-Feature-Engineering-and-Training/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&text=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&is_video=false&description=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MLOps Part 3 - Evaluation and Optimization&body=Check out this article: https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&name=MLOps Part 3 - Evaluation and Optimization&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&t=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-evaluate-step"><span class="toc-number">1.</span> <span class="toc-text">Develop evaluate step</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Adding-in-logic"><span class="toc-number">1.1.</span> <span class="toc-text">Adding in logic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-up-entry-point"><span class="toc-number">1.2.</span> <span class="toc-text">Setting up entry point</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Test-run"><span class="toc-number">1.3.</span> <span class="toc-text">Test run</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Model-retraining-with-hyperparameter-sweep"><span class="toc-number">2.</span> <span class="toc-text">Model retraining with hyperparameter sweep</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prepare-model-for-deployment"><span class="toc-number">3.</span> <span class="toc-text">Prepare model for deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Give-the-optimal-model-a-custom-tag"><span class="toc-number">3.1.</span> <span class="toc-text">Give the optimal model a custom tag</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MLOps Part 3 - Evaluation and Optimization
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Izzuddin Ahsanujunda</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-10-21T04:57:21.000Z" itemprop="datePublished">2021-10-21</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/mlops-machine-learning/" rel="tag">mlops, machine-learning</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Now that we have trained a model and store it as a reusable artifact, we are ready to evaluate the model on unseen data. As with usual training practice, we are going to pull out the test portion of our split data, run this data through the trained model, and record the score we got from the test data. As a good measure, we will also re-run training process with mlflow-powered hyperparameter sweep and discover the most optimal hyperparameter that could gave us best generalization between training and testing data.</p>
<p>One important thing that is often overlooked when building a training pipeline is monitoring model drift and data drift. Therefore we are going to implement storing the distribution of our label and each of the features during training as a summary with the <code>r2</code> and <code>mae</code> performance metrics. When comparing two models, we can use this summary to compare the distribution of the data that is used to train each respective model.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1KVqCU7TUzuln1CPufvR60X9_a4Evqf1r" alt="image"></p>
<p>We’re gonna finish the <code>evaluate</code> part or our pipeline. Let’s go!</p>
<h2 id="Develop-evaluate-step"><a href="#Develop-evaluate-step" class="headerlink" title="Develop evaluate step"></a>Develop evaluate step</h2><h3 id="Adding-in-logic"><a href="#Adding-in-logic" class="headerlink" title="Adding in logic"></a>Adding in logic</h3><p>We need to add new function to our <code>BaseRunner</code> class. Open <code>nyc_airbnb/utils/base_model.py</code> and add the following changes.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;utils&#x2F;base_runner.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseRunner</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, wandb_run</span>):</span><br><span class="line">        self.wandb_run = wandb_run</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_artifact</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                     artifact_name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     artifact_type: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     artifact_description: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                     filename: <span class="built_in">str</span></span>) -&gt; wandb.Artifact:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Log the provided local filename as an artifact in W&amp;B, and add the artifact path</span></span><br><span class="line"><span class="string">        to the MLFlow run so it can be retrieved by subsequent steps in a pipeline</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            artifact_name: name for the artifact</span></span><br><span class="line"><span class="string">            artifact_type:</span></span><br><span class="line"><span class="string">                type for the artifact (just a string like &quot;raw_data&quot;, &quot;clean_data&quot; and so on)</span></span><br><span class="line"><span class="string">            artifact_description: a brief description of the artifact</span></span><br><span class="line"><span class="string">            filename: local filename for the artifact</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Wandb artifact object</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Log to W&amp;B</span></span><br><span class="line">        artifact = wandb.Artifact(</span><br><span class="line">            artifact_name,</span><br><span class="line">            <span class="built_in">type</span>=artifact_type,</span><br><span class="line">            description=artifact_description,</span><br><span class="line">        )</span><br><span class="line">        artifact.add_file(filename)</span><br><span class="line">        self.wandb_run.log_artifact(artifact)</span><br><span class="line">        logger.info(<span class="string">f&quot;Uploading <span class="subst">&#123;artifact_name&#125;</span> to Weights &amp; Biases&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We need to call .wait() method to ensure that artifact transport has completed</span></span><br><span class="line">        <span class="comment"># before we exit this method execution</span></span><br><span class="line">        <span class="keyword">if</span> wandb.run.mode == <span class="string">&#x27;online&#x27;</span>:</span><br><span class="line">            artifact.wait()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> artifact</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_model</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                  artifact_name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                  artifact_type: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                  artifact_description: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">                  model_dir: <span class="built_in">str</span></span>) -&gt; wandb.Artifact:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Log the provided local filename as an artifact in W&amp;B, and add the artifact path</span></span><br><span class="line"><span class="string">        to the MLFlow run so it can be retrieved by subsequent steps in a pipeline</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            artifact_name: name for the artifact</span></span><br><span class="line"><span class="string">            artifact_type:</span></span><br><span class="line"><span class="string">                type for the artifact (just a string like &quot;raw_data&quot;, &quot;clean_data&quot; and so on)</span></span><br><span class="line"><span class="string">            artifact_description: a brief description of the artifact</span></span><br><span class="line"><span class="string">            model_dir: local path for the model directory</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Wandb artifact object</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Log to W&amp;B</span></span><br><span class="line">        artifact = wandb.Artifact(</span><br><span class="line">            artifact_name,</span><br><span class="line">            <span class="built_in">type</span>=artifact_type,</span><br><span class="line">            description=artifact_description,</span><br><span class="line">        )</span><br><span class="line">        artifact.add_dir(model_dir)</span><br><span class="line">        self.wandb_run.log_artifact(artifact)</span><br><span class="line">        <span class="comment"># We need to call .wait() method to ensure that artifact transport has completed</span></span><br><span class="line">        <span class="comment"># before we exit this method execution</span></span><br><span class="line">        <span class="keyword">if</span> wandb.run.mode == <span class="string">&#x27;online&#x27;</span>:</span><br><span class="line">            artifact.wait()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> artifact</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_dataset_artifact</span>(<span class="params">self, artifact_name</span>) -&gt; pd.DataFrame:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Retrieve wandb artifact as pandas DataFrame, artifact_name should exist in</span></span><br><span class="line"><span class="string">        the context of current run. This function will only retrieve dataset artifact,</span></span><br><span class="line"><span class="string">        not model or any other artifact type.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            artifact_name: name for the artifact</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            DataFrame representation of the artifact</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        artifact_local_path = self.wandb_run.use_artifact(artifact_name).file()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = pd.read_parquet(artifact_local_path)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> err:</span><br><span class="line">            logger.error(<span class="string">f&quot;<span class="subst">&#123;artifact_name&#125;</span> is not found&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> err</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_model</span>(<span class="params">self, model_artifact</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Retrieve model artifact from wandb.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        model_artifact: name for the artifact</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        MLflow compatible model</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">&quot;Downloading model&quot;</span>)</span><br><span class="line">    <span class="comment"># Download input artifact. This will also log that this script is using this</span></span><br><span class="line">    <span class="comment"># particular version of the artifact</span></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> temp_dir:</span><br><span class="line">        model_local_path = self.wandb_run.use_artifact(model_artifact) \</span><br><span class="line">            .download(<span class="string">f&#x27;<span class="subst">&#123;temp_dir&#125;</span>/&#x27;</span>)</span><br><span class="line">        model = mlflow.sklearn.load_model(model_local_path)</span><br><span class="line">        <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>
</blockquote>
<p>We can call this new function in evaluation entry point that we are going to build. But first, create a new file.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch nyc_airbnb/evaluate.py</span><br></pre></td></tr></table></figure>

<p>Now let’s put in the logic for evaluation.</p>
<blockquote>
<p>.&#x2F;nyc_airbnb&#x2F;evaluate.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> r2_score, mean_absolute_error</span><br><span class="line"></span><br><span class="line">sys.path.append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> nyc_airbnb.utils.base_runner <span class="keyword">import</span> BaseRunner</span><br><span class="line"></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&quot;%(asctime)-15s %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EvaluateModelRunner</span>(<span class="title class_ inherited__">BaseRunner</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, wandb_run</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(wandb_run)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_data</span>(<span class="params">self, data: pd.DataFrame, model, label: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="comment"># Read test dataset</span></span><br><span class="line">        X_test = data.copy()</span><br><span class="line">        y_test = X_test.pop(label)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Predict</span></span><br><span class="line">        y_pred = model.predict(X_test)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Evaluate</span></span><br><span class="line">        logger.info(<span class="string">&quot;Scoring&quot;</span>)</span><br><span class="line">        r2 = r2_score(y_test, y_pred)</span><br><span class="line">        mae = mean_absolute_error(y_test, y_pred)</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;Score: <span class="subst">&#123;r2&#125;</span>&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;MAE: <span class="subst">&#123;mae&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Log MAE and r2</span></span><br><span class="line">        self.wandb_run.summary[<span class="string">&#x27;Test r2&#x27;</span>] = r2</span><br><span class="line">        self.wandb_run.summary[<span class="string">&#x27;Test mae&#x27;</span>] = mae</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> y_pred, r2, mae</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Process arguments</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;Clean the training dataset&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;test_model&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Artifact name of trained model&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;test_dataset&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Artifact name of test dataset&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;label&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Label of test dataset&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    wandb_run = wandb.init(job_type=<span class="string">&quot;test_model&quot;</span>)</span><br><span class="line"></span><br><span class="line">    runner = EvaluateModelRunner(wandb_run)</span><br><span class="line">    test_set = runner.retrieve_dataset_artifact(args.test_dataset)</span><br><span class="line">    model = runner.retrieve_model(args.test_model)</span><br><span class="line">    _ = runner.test_data(test_set, model, args.label)</span><br><span class="line"></span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Setting-up-entry-point"><a href="#Setting-up-entry-point" class="headerlink" title="Setting up entry point"></a>Setting up entry point</h3><p>We’re half way through, let’s open <code>MLproject</code> and add new entry point for evaluation there.</p>
<blockquote>
<p>.&#x2F;MLproject</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">nyc_airbnb</span></span><br><span class="line"><span class="attr">conda_env:</span> <span class="string">conda.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">entry_points:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Comma-separated</span> <span class="string">list</span> <span class="string">of</span> <span class="string">steps</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">(useful</span> <span class="string">for</span> <span class="string">debugging)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">all</span></span><br><span class="line">      <span class="attr">hydra_options:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Other</span> <span class="string">configuration</span> <span class="string">parameters</span> <span class="string">to</span> <span class="string">override</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">str</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python main.py main.steps=\\&#x27;&#123;steps&#125;\\&#x27; $(echo &#123;hydra_options&#125;)&quot;</span></span><br><span class="line">  <span class="attr">get_data:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">bucket:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">bucket</span> <span class="string">where</span> <span class="string">data</span> <span class="string">is</span> <span class="string">stored</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">object_path:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">OSS</span> <span class="string">object</span> <span class="string">of</span> <span class="string">dataset</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_name:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Name</span> <span class="string">for</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_type:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Type</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact.</span> <span class="string">This</span> <span class="string">will</span> <span class="string">be</span> <span class="string">used</span> <span class="string">to</span> <span class="string">categorize</span> <span class="string">the</span> <span class="string">artifact</span> <span class="string">in</span> <span class="string">the</span> <span class="string">W&amp;B</span> <span class="string">interface</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">artifact_description:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">A</span> <span class="string">brief</span> <span class="string">description</span> <span class="string">of</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/get_data.py</span></span><br><span class="line"><span class="string">        &#123;bucket&#125;</span></span><br><span class="line"><span class="string">        &#123;object_path&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_name&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_type&#125;</span></span><br><span class="line"><span class="string">        &#123;artifact_description&#125;&quot;</span></span><br><span class="line">  <span class="attr">split:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">input_artifact:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Artifact</span> <span class="string">to</span> <span class="string">split</span> <span class="string">(a</span> <span class="string">CSV</span> <span class="string">file)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">test_size:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">test</span> <span class="string">split.</span> <span class="string">Fraction</span> <span class="string">of</span> <span class="string">the</span> <span class="string">dataset,</span> <span class="string">or</span> <span class="string">number</span> <span class="string">of</span> <span class="string">items</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">random_seed:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Seed</span> <span class="string">for</span> <span class="string">the</span> <span class="string">random</span> <span class="string">number</span> <span class="string">generator.</span> <span class="string">Use</span> <span class="string">this</span> <span class="string">for</span> <span class="string">reproducibility</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">default:</span> <span class="number">42</span></span><br><span class="line">      <span class="attr">stratify_by:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Column</span> <span class="string">to</span> <span class="string">use</span> <span class="string">for</span> <span class="string">stratification</span> <span class="string">(if</span> <span class="string">any)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;none&#x27;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/split_train_test.py</span></span><br><span class="line"><span class="string">        &#123;input_artifact&#125;</span></span><br><span class="line"><span class="string">        &#123;test_size&#125;</span></span><br><span class="line"><span class="string">        &#123;random_seed&#125;</span></span><br><span class="line"><span class="string">        &#123;stratify_by&#125;&quot;</span></span><br><span class="line">  <span class="attr">train:</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">      <span class="attr">label:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Label</span> <span class="string">column</span> <span class="string">name</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">trainval_artifact:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Train</span> <span class="string">dataset</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">val_size:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">validation</span> <span class="string">split.</span> <span class="string">Fraction</span> <span class="string">of</span> <span class="string">the</span> <span class="string">dataset,</span> <span class="string">or</span> <span class="string">number</span> <span class="string">of</span> <span class="string">items</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">random_seed:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Seed</span> <span class="string">for</span> <span class="string">the</span> <span class="string">random</span> <span class="string">number</span> <span class="string">generator.</span> <span class="string">Use</span> <span class="string">this</span> <span class="string">for</span> <span class="string">reproducibility</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">default:</span> <span class="number">42</span></span><br><span class="line">      <span class="attr">stratify_by:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Column</span> <span class="string">to</span> <span class="string">use</span> <span class="string">for</span> <span class="string">stratification</span> <span class="string">(if</span> <span class="string">any)</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;none&#x27;</span></span><br><span class="line">      <span class="attr">rf_config:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Random</span> <span class="string">forest</span> <span class="string">configuration.</span> <span class="string">A</span> <span class="string">path</span> <span class="string">to</span> <span class="string">a</span> <span class="string">JSON</span> <span class="string">file</span> <span class="string">with</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">that</span> <span class="string">will</span></span><br><span class="line">                    <span class="string">be</span> <span class="string">passed</span> <span class="string">to</span> <span class="string">the</span> <span class="string">scikit-learn</span> <span class="string">constructor</span> <span class="string">for</span> <span class="string">RandomForestRegressor.</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">max_tfidf_features:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Maximum</span> <span class="string">number</span> <span class="string">of</span> <span class="string">words</span> <span class="string">to</span> <span class="string">consider</span> <span class="string">for</span> <span class="string">the</span> <span class="string">TFIDF</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">output_artifact:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Name</span> <span class="string">for</span> <span class="string">the</span> <span class="string">output</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/train.py</span></span><br><span class="line"><span class="string">        &#123;label&#125;</span></span><br><span class="line"><span class="string">        &#123;trainval_artifact&#125;</span></span><br><span class="line"><span class="string">        &#123;val_size&#125;</span></span><br><span class="line"><span class="string">        &#123;random_seed&#125;</span></span><br><span class="line"><span class="string">        &#123;stratify_by&#125;</span></span><br><span class="line"><span class="string">        &#123;rf_config&#125;</span></span><br><span class="line"><span class="string">        &#123;max_tfidf_features&#125;</span></span><br><span class="line"><span class="string">        &#123;output_artifact&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">evaluate:</span></span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">test_model:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">An</span> <span class="string">MLflow</span> <span class="string">serialized</span> <span class="string">model</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">test_dataset:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">The</span> <span class="string">test</span> <span class="string">artifact</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">label:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Label</span> <span class="string">of</span> <span class="string">the</span> <span class="string">prediction</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">&quot;python nyc_airbnb/evaluate.py</span></span><br><span class="line"><span class="string">      &#123;test_model&#125;</span></span><br><span class="line"><span class="string">      &#123;test_dataset&#125;</span></span><br><span class="line"><span class="string">      &#123;label&#125;&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>Now we are going to call this new entry point from our <code>main.py</code></p>
<blockquote>
<p>.&#x2F;main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> mlflow</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hydra</span><br><span class="line"><span class="keyword">from</span> omegaconf <span class="keyword">import</span> DictConfig</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_steps = [</span><br><span class="line">    <span class="string">&#x27;download&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;split&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;train&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;evaluate&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># This decorator automatically reads in the configuration</span></span><br><span class="line"><span class="meta">@hydra.main(<span class="params">config_name=<span class="string">&#x27;config&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">go</span>(<span class="params">config: DictConfig</span>):</span><br><span class="line">    <span class="comment"># Setup the wandb experiment. All runs will be grouped under this name</span></span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_PROJECT&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;project_name&quot;</span>]</span><br><span class="line">    os.environ[<span class="string">&quot;WANDB_RUN_GROUP&quot;</span>] = config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;experiment_name&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Steps to execute</span></span><br><span class="line">    steps_par = config[<span class="string">&#x27;main&#x27;</span>][<span class="string">&#x27;steps&#x27;</span>]</span><br><span class="line">    active_steps = steps_par.split(<span class="string">&quot;,&quot;</span>) <span class="keyword">if</span> steps_par != <span class="string">&quot;all&quot;</span> <span class="keyword">else</span> _steps</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Move to a temporary directory</span></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;download&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            <span class="comment"># Download file and load in W&amp;B</span></span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                hydra.utils.get_original_cwd(),</span><br><span class="line">                <span class="string">&quot;get_data&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;bucket&quot;</span>: config[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;bucket&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;object_path&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_type&quot;</span>: <span class="string">&quot;raw_data&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;artifact_description&quot;</span>: <span class="string">&quot;Raw dataset from data store&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;split&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                hydra.utils.get_original_cwd(),</span><br><span class="line">                <span class="string">&quot;split&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;input_artifact&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;raw_data&#x27;</span>]&#125;</span>:latest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;test_size&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;test_size&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;random_seed&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;random_seed&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;stratify_by&quot;</span>: config[<span class="string">&#x27;modeling&#x27;</span>][<span class="string">&#x27;stratify_by&#x27;</span>],</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;train&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            <span class="comment"># <span class="doctag">NOTE:</span> we need to serialize the random forest configuration into JSON</span></span><br><span class="line">            rf_config = os.path.abspath(<span class="string">&quot;rf_config.json&quot;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(rf_config, <span class="string">&quot;w+&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                json.dump(<span class="built_in">dict</span>(config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;random_forest&quot;</span>].items()), fp)  <span class="comment"># DO NOT TOUCH</span></span><br><span class="line">            <span class="comment"># <span class="doctag">NOTE:</span> use the rf_config we just created as the rf_config parameter for the train_random_forest</span></span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                os.path.join(hydra.utils.get_original_cwd()),</span><br><span class="line">                <span class="string">&quot;train&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;label&quot;</span>: config[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;label&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;trainval_artifact&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;training_data&#x27;</span>]&#125;</span>:latest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;val_size&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;val_size&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;random_seed&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;random_seed&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;stratify_by&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;stratify_by&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;rf_config&quot;</span>: rf_config,</span><br><span class="line">                    <span class="string">&quot;max_tfidf_features&quot;</span>: config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;max_tfidf_features&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;output_artifact&quot;</span>: config[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;experiment_name&quot;</span>],</span><br><span class="line">                &#125;,</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> <span class="string">&quot;evaluate&quot;</span> <span class="keyword">in</span> active_steps:</span><br><span class="line">            _ = mlflow.run(</span><br><span class="line">                os.path.join(hydra.utils.get_original_cwd()),</span><br><span class="line">                <span class="string">&quot;test&quot;</span>,</span><br><span class="line">                parameters=&#123;</span><br><span class="line">                    <span class="string">&quot;test_model&quot;</span>: <span class="string">f&#x27;<span class="subst">&#123;config[<span class="string">&quot;modeling&quot;</span>][<span class="string">&quot;test_model&quot;</span>]&#125;</span>&#x27;</span>,</span><br><span class="line">                    <span class="string">&quot;test_dataset&quot;</span>: config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;test_data&#x27;</span>],</span><br><span class="line">                    <span class="string">&quot;label&quot;</span>: config[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;label_col&#x27;</span>],</span><br><span class="line">                &#125;,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    go()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Now that we can call <code>evaluate</code> from <code>main</code> entry point, we just need to add configuration that will be passed in to <code>evaluate</code> step.</p>
<blockquote>
<p>.&#x2F;config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">main:</span></span><br><span class="line">  <span class="attr">project_name:</span> <span class="string">&quot;nyc_airbnb&quot;</span></span><br><span class="line">  <span class="attr">experiment_name:</span> <span class="string">&quot;random_forest_model&quot;</span></span><br><span class="line">  <span class="attr">steps:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">&quot;junda-mlops&quot;</span></span><br><span class="line">  <span class="attr">object:</span> <span class="string">&quot;dataset/training_data/&quot;</span></span><br><span class="line">  <span class="attr">raw_data:</span> <span class="string">&quot;raw_training_data.parquet&quot;</span></span><br><span class="line">  <span class="attr">training_data:</span> <span class="string">&quot;trainval_data.parquet&quot;</span></span><br><span class="line">  <span class="attr">test_data:</span> <span class="string">&quot;test_data.parquet&quot;</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">&quot;price&quot;</span></span><br><span class="line"><span class="attr">modeling:</span></span><br><span class="line">  <span class="comment"># Name of exported model to be used in testing model</span></span><br><span class="line">  <span class="attr">test_model:</span> <span class="string">&quot;random_forest_model:latest&quot;</span></span><br><span class="line">  <span class="comment"># Fraction of data to use for test (the remaining will be used for train and validation)</span></span><br><span class="line">  <span class="attr">test_size:</span> <span class="number">0.2</span></span><br><span class="line">  <span class="comment"># Fraction of remaining data to use for validation</span></span><br><span class="line">  <span class="attr">val_size:</span> <span class="number">0.2</span></span><br><span class="line">  <span class="comment"># Fix this for reproducibility, change to have new splits</span></span><br><span class="line">  <span class="attr">random_seed:</span> <span class="number">42</span></span><br><span class="line">  <span class="comment"># Column to use for stratification (use &quot;none&quot; for no stratification)</span></span><br><span class="line">  <span class="attr">stratify_by:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="attr">max_tfidf_features:</span> <span class="number">15</span></span><br><span class="line">  <span class="comment"># <span class="doctag">NOTE:</span> you can put here any parameter that is accepted by the constructor of</span></span><br><span class="line">  <span class="comment"># RandomForestRegressor. This is a subsample, but more could be added:</span></span><br><span class="line">  <span class="attr">random_forest:</span></span><br><span class="line">    <span class="attr">n_estimators:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">max_depth:</span> <span class="number">12</span></span><br><span class="line">    <span class="attr">min_samples_split:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">min_samples_leaf:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># Here -1 means all available cores</span></span><br><span class="line">    <span class="attr">n_jobs:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">criterion:</span> <span class="string">mae</span></span><br><span class="line">    <span class="attr">max_features:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="comment"># DO not change the following</span></span><br><span class="line">    <span class="attr">oob_score:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Test-run"><a href="#Test-run" class="headerlink" title="Test run"></a>Test run</h3><p>Now we can run <code>evaluate</code> step. However, just for presentation purpose, let’s run both <code>train</code> and <code>evaluate</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mlflow run . -P steps=train,evaluate</span><br></pre></td></tr></table></figure>

<p>If we open wandb dashboard now, we can see our previous training run without test r2 and test mae. WHile our most recent run has all score recorded for test and training.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1WUKB5kZDA3Fxp55exCOA9nFBg2f-M9dV" alt="wandb screenshot"></p>
<h2 id="Model-retraining-with-hyperparameter-sweep"><a href="#Model-retraining-with-hyperparameter-sweep" class="headerlink" title="Model retraining with hyperparameter sweep"></a>Model retraining with hyperparameter sweep</h2><p>Now that we have finish our pipeline to run end-to-end training, now it is time for us to discover the best hyperparameter to use with our model. Our usage of <code>hydra</code> for configuration management really stand out here. Every entry in our <code>config.yaml</code> can easily be overriden from CLI, and we can also pass multiple values to be sweeped. Each combination of value we passed to sweep will be recorder on wandb so we can decide which model works best.</p>
<p>To sweep along multiple hyperparameter values, run this command.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mlflow run . \</span><br><span class="line">-P steps=train \</span><br><span class="line">-P hydra_options=&quot;modeling.random_seed=42,122 modeling.random_forest.max_depth=11,12,13 modeling.random_forest.min_samples_split=3,4,5 -m&quot;</span><br></pre></td></tr></table></figure>

<p>This execution will run for a while because there are 2x3x3&#x3D;18 combination of hyper parameters to be sweeped. As we wait for the hyperparameter sweep to finish, we can cheeck the wandb dashboard to see which combination has been executed and their respective training scores.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1pXGQt1VMu6b8uMs3Y0xfOSuQ0ROU4laL" alt="wandb sweep"></p>
<p>Now that we have sweep across training run, we can check which run results in best <strong>training</strong> performance. Actually, let’s get top 3 and note down their model version.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1BcZet0aZFdOaDgCGy385RG7j9ZwI2qrs" alt="model 1"></p>
<p><img src="https://drive.google.com/uc?export=view&id=1bvvNk39nZ74ZrxGrhC44CbG13yLryUqy" alt="model 2"></p>
<p><img src="https://drive.google.com/uc?export=view&id=11wbp_dUyZUiHGScY5GkFP0sWaj-NZayW" alt="model 3"></p>
<p>Above screenshot show top three model with best <strong>training</strong> performance. Model version <code>v18</code>, <code>v7</code>, and <code>v8</code> with score of $R^{2}$ 0.239, 0.237, and 0.233 respectively.</p>
<p>Because we care more about how our model perform on data not seen on training, let’s run testing step with these three models. We can use hydra sweep again.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mlflow run . \</span><br><span class="line">-P steps=evaluate \</span><br><span class="line">-P hydra_options=&quot;modeling.test_model=random_forest_model:v18,random_forest_model:v7,random_forest_model:v8 -m&quot;</span><br></pre></td></tr></table></figure>

<p>Wait until the run finish sweep on three models.</p>
<h2 id="Prepare-model-for-deployment"><a href="#Prepare-model-for-deployment" class="headerlink" title="Prepare model for deployment"></a>Prepare model for deployment</h2><h3 id="Give-the-optimal-model-a-custom-tag"><a href="#Give-the-optimal-model-a-custom-tag" class="headerlink" title="Give the optimal model a custom tag"></a>Give the optimal model a custom tag</h3><p>Once sweeping run finish on <code>evaluate</code> step, check wandb dashboard again, and check which run gave the best <strong>testing</strong> performance. Click on the run name, and click again on the artifact name.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1Cqv2Uzt8Srp-i9dTHR8Lq6jxA__YaMfq" alt="wandb run list"></p>
<p><img src="https://drive.google.com/uc?export=view&id=1T3umZFxiGYo6LnSjNTOiqlbMrmHdfRAm" alt="wandb run list"></p>
<p>From here, look for the model name, and click on it. On the model page, give a new custom tag called <code>staging</code>. Any consuming systems should always get this <code>staging</code> model. Eventually we are also going to give a <code>prod</code> tag. But every model that wants to be <code>prod</code> should become <code>staging</code> first.</p>
<p><img src="https://drive.google.com/uc?export=view&id=1ndvWMeNmwfbRIz4TUVC6sSzfFMboG6hL" alt="wandb run list"></p>
<p><img src="https://drive.google.com/uc?export=view&id=1FKMrCMYCjzjQ0uKRCXH1zTLEgpDLzwVk" alt="wandb run list"></p>
<!-- ### Add training data distribution into run summary -->



  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/About-Me/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop-evaluate-step"><span class="toc-number">1.</span> <span class="toc-text">Develop evaluate step</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Adding-in-logic"><span class="toc-number">1.1.</span> <span class="toc-text">Adding in logic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-up-entry-point"><span class="toc-number">1.2.</span> <span class="toc-text">Setting up entry point</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Test-run"><span class="toc-number">1.3.</span> <span class="toc-text">Test run</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Model-retraining-with-hyperparameter-sweep"><span class="toc-number">2.</span> <span class="toc-text">Model retraining with hyperparameter sweep</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prepare-model-for-deployment"><span class="toc-number">3.</span> <span class="toc-text">Prepare model for deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Give-the-optimal-model-a-custom-tag"><span class="toc-number">3.1.</span> <span class="toc-text">Give the optimal model a custom tag</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&text=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&is_video=false&description=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MLOps Part 3 - Evaluation and Optimization&body=Check out this article: https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&title=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&name=MLOps Part 3 - Evaluation and Optimization&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://iahsanujunda.github.io/posts/20211021/MLOps-Part-3-Evaluation-and-Optimization/&t=MLOps Part 3 - Evaluation and Optimization"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2023
    Izzuddin Ahsanujunda
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/About-Me/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/iahsanujunda">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'iahsanujunda/iahsanujunda.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
